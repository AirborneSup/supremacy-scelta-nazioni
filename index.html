<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scelta Nazioni Supremacy 1914 ITA</title>
    <!-- Font Awesome e jsPDF -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- CSS (CON FONT VOLLKORN) --- */
        /* MODIFICA 1: Importare Vollkorn */
        @import url('https://fonts.googleapis.com/css2?family=Vollkorn:wght@400;700&display=swap');

        :root { /* Variabili con Vollkorn */
            --color-background: #C1B5A5; --color-container-bg: rgba(245, 235, 215, 0.96); --color-container-border: #A08C70; --color-text-dark: #2E231A; --color-text-medium: #4B3A2A; --color-text-light: #F5F0E5; --color-accent-dark: #800000; --color-accent-medium: #8A704E; --color-accent-light: #B0987C; --color-disabled-bg: #D0C8B8; --color-disabled-border: #A08C70; --color-disabled-text: #70685A; --color-player-bg: #EAE0C8; --color-player-active-bg: #D8CCA8; --color-card-bg: #F8F2E4; --color-card-hover-bg: #FFFBF0; --color-list-bg: rgba(255, 250, 235, 0.95);
            /* MODIFICA 2: Usare Vollkorn per corpo e display */
            --font-serif: 'Vollkorn', Georgia, serif; /* Corpo testo (Regular 400) */
            --font-serif-display: 'Vollkorn', Georgia, serif; /* Titoli, Bottoni (Bold 700 sarà applicato via font-weight) */
            --font-sans-serif:'Helvetica Neue', Helvetica, Arial, sans-serif; /* Fallback sans-serif */
            --font-mono:'Courier New', Courier, monospace;
            --base-border-radius: 3px; --transition-speed:.25s; --shadow-color: rgba(0, 0, 0, .18); --shadow-color-darker: rgba(0, 0, 0, .30);
         }

         *, ::after, ::before { box-sizing: border-box }
        body { background-image: url(https://clan.cloudflare.steamstatic.com/images/34123292/58502dadd0af1a8c8758d8c8a7f77978d01c0e6a.jpg); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed;
               font-family: var(--font-serif); /* Usa Vollkorn Regular */
               margin: 0; padding: 25px; color: var(--color-text-dark); min-height: 100vh; line-height: 1.65; overflow-x: hidden; position: relative; -webkit-text-size-adjust: 100% }
        body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-shadow: inset 0 0 100px rgba(0, 0, 0, .25); pointer-events: none; z-index: -1 }
        .container { max-width: 1100px; margin: 25px auto; background-image: url('https://www.transparenttextures.com/patterns/old-paper.png'); background-color: var(--color-container-bg); padding: 35px; border-radius: var(--base-border-radius); box-shadow: 0 10px 35px var(--shadow-color-darker), inset 0 0 15px rgba(0,0,0,0.1); border: 2px solid var(--color-container-border); position: relative }

        /* MODIFICA 3: Stile H1 con Vollkorn Bold */
        h1 {
            text-align: center;
            color: var(--color-accent-dark);
            margin-top: 0;
            margin-bottom: 40px;
            font-family: var(--font-serif-display); /* Usa Vollkorn */
            font-weight: 700; /* Seleziona Vollkorn Bold */
            text-transform: uppercase; /* Manteniamo maiuscolo per impatto */
            letter-spacing: 1px; /* Ridotta spaziatura */
            border-bottom: 2px solid var(--color-accent-light);
            padding-bottom: 18px;
            font-size: 2.2em; /* Leggermente aggiustata */
            text-shadow: 1px 1px 0px var(--color-text-light), 2px 2px 3px rgba(0,0,0,0.2);
        }

        /* MODIFICA 4: Aggiustamenti h2, h3 */
        h2, h3 {
            font-family: var(--font-serif-display); /* Usa Vollkorn */
            font-weight: 700; /* Seleziona Vollkorn Bold */
            text-transform: uppercase;
            color: var(--color-text-medium);
            letter-spacing: 0.5px; /* Ridotta spaziatura */
            margin-bottom: 15px;
        }

        #alliance-select { padding: 12px; margin: 10px 0; border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); width: 100%; box-sizing: border-box; background-color: #FFFDF5; color: var(--color-text-dark); font-family: var(--font-serif); font-size: 1em; transition: all var(--transition-speed) ease; cursor: pointer; }
        #alliance-select:focus { border-color: var(--color-text-medium); outline: none; box-shadow: 0 0 8px rgba(90, 71, 53, .4); background-color: #fff; }
        #alliance-select:disabled { cursor: not-allowed; background-color: var(--color-disabled-bg); opacity: 0.7; }
        .alliance-info { display: flex; align-items: center; margin-bottom: 10px; min-height: 30px; margin-top: 5px; }
        .alliance-logo { width: 30px; height: 30px; object-fit: contain; margin-right: 8px; vertical-align: middle; background-color: rgba(0,0,0,0.05); border-radius: 3px; display: inline-block; image-rendering: -webkit-optimize-contrast; }
        .alliance-name { font-size: 0.95em; color: var(--color-text-medium); font-style: italic; font-weight: bold; /* Potrebbe usare --font-serif qui, ma bold italic va bene */ }
        .summary-alliance { margin-bottom: 8px; display: flex; align-items: center; }
        .summary-alliance strong { margin-right: 5px; }
        .summary-alliance .alliance-logo { width: 20px; height: 20px; margin-right: 5px; }
        .game-phase { margin-bottom: 30px; padding: 20px 30px; background-color: rgba(210, 190, 160, 0.95); border-radius: 0; text-align: center; font-weight: 700; border: 1px solid var(--color-accent-medium); color: var(--color-text-dark); min-height: 50px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-family: var(--font-serif-display); font-size: 1.25em; text-transform: uppercase; letter-spacing: 0.5px; /* Ridotta */ transition: background-color var(--transition-speed) ease; box-shadow: 0 2px 5px var(--shadow-color), inset 0 0 10px rgba(0,0,0,0.15); }
        .game-phase span[style*="color"] { text-shadow: 1px 1px 1px rgba(255, 255, 255, .4) }
        .hero-status { font-size: .85em; font-style: italic; margin-top: 5px; color: var(--color-text-dark); display: block; width: 100%; font-family: var(--font-serif); /* Usa Vollkorn Regular */ text-transform: none; letter-spacing: normal; }
        .timer-container { text-align: center; margin: 25px 0 }
        .timer { font-size: 1.5em; color: var(--color-accent-dark); margin: 0 0 8px; text-align: center; min-height: 1.5em; font-family: var(--font-mono); background-color: rgba(248, 244, 232, .8); padding: 5px 10px; display: inline-block; border-radius: var(--base-border-radius); border: 1px solid rgba(139, 0, 0, .4); box-shadow: 0 1px 3px var(--shadow-color) }
        .timer-bar-container { width: 250px; max-width: 80%; height: 8px; background-color: rgba(0, 0, 0, .1); border: 1px solid var(--color-accent-light); border-radius: 4px; margin: 0 auto; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0, 0, 0, .1) }
        .timer-bar { height: 100%; width: 100%; background: linear-gradient(to right, var(--color-accent-dark), #b50000); border-radius: 3px; transition: width 1s linear }
        .players-container { display: flex; justify-content: space-between; margin-bottom: 40px; flex-wrap: wrap; gap: 25px }
        .player { width: 100%; padding: 25px; background: linear-gradient(to bottom, var(--color-player-bg), #D8CCA8); border-radius: var(--base-border-radius); box-shadow: 0 2px 6px var(--shadow-color), inset 0 0 0 1px var(--color-accent-light); border: 1px solid var(--color-container-border); box-sizing: border-box; transition: all var(--transition-speed) ease; border-left: 6px solid transparent; }
        @media (min-width:768px) { .player { width: calc(50% - 13px) } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 2px 6px var(--shadow-color), inset 0 0 0 1px var(--color-accent-dark); } 50% { transform: scale(1.02); box-shadow: 0 5px 15px var(--shadow-color-darker), inset 0 0 0 1px var(--color-accent-dark); } 100% { transform: scale(1); box-shadow: 0 2px 6px var(--shadow-color), inset 0 0 0 1px var(--color-accent-dark); } }
        .player.active { border-left-color: var(--color-accent-dark); box-shadow: 0 4px 12px var(--shadow-color-darker), inset 0 0 0 1px var(--color-accent-dark); }
        .player.turn-pulse { animation: pulse .6s ease-in-out }
        .player h2 { margin-top: 0; border-bottom: 1px solid var(--color-accent-light); padding-bottom: 12px; font-size: 1.25em; margin-bottom: 10px; }
        .hero-selection-section, .summary-section { margin-top: 30px; padding: 25px; background-color: rgba(216, 200, 168, .8); border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); text-align: center }
        .hero-selection-section h3, .summary-section h3 { margin-top: 0; border-bottom: 1px solid var(--color-accent-light); padding-bottom: 10px; margin-bottom: 20px }
        .hero-choice-buttons button { margin: 0 10px; font-size: .95em; padding: 8px 18px }
        .hero-choice-buttons button.selected { background: linear-gradient(to bottom, var(--color-accent-dark), #5c0000); border-color: var(--color-accent-dark); color: var(--color-text-light); cursor: default }
        .summary-details { display: flex; flex-direction: column; gap: 15px; text-align: left; margin-bottom: 15px }
        .summary-player { width: 100% }
        .summary-player ul { list-style: none; padding-left: 0; margin-top: 5px }
        .summary-player li { margin-bottom: 4px; font-size: .95em; display: flex; align-items: center; }
        .summary-player .hero-decision { font-weight: 700 }
        .summary-player .hero-decision .yes { color: darkgreen }
        .summary-player .hero-decision .no { color: var(--color-accent-dark) }
        @media (min-width:600px) { .summary-details { flex-direction: row; justify-content: space-around; gap: 20px } .summary-player { width: calc(50% - 20px); min-width: 280px } }
        #download-confirmation { font-style: italic; color: var(--color-text-medium); margin-top: 15px; font-size: .9em }
        .nations-container { margin-top: 25px }
        .nations-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 20px 0 }
        @media (max-width:900px) { .nations-grid { grid-template-columns: repeat(4, 1fr) } }
        @media (max-width:700px) { .nations-grid { grid-template-columns: repeat(3, 1fr); gap: 10px } }
        @media (max-width:480px) { .nations-grid { grid-template-columns: repeat(3, 1fr); gap: 8px } }
        .nation-card { border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); padding: 10px; text-align: center; cursor: default; transition: all var(--transition-speed) ease-in-out; background: linear-gradient(to bottom, var(--color-card-bg), #E8E0D0); box-shadow: 0 2px 5px var(--shadow-color); position: relative; overflow: hidden; }
        .nation-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(rgba(255,255,255,0.05), rgba(0,0,0,0.05)); opacity: 0; transition: opacity var(--transition-speed) ease; pointer-events: none; }
        .nation-card.available:hover { border-color: var(--color-accent-medium); background: linear-gradient(to bottom, var(--color-card-hover-bg), #F0E8D8); cursor: pointer; transform: translateY(-6px) scale(1.04); box-shadow: 0 10px 20px var(--shadow-color-darker); z-index: 10; }
        .nation-card.available:hover::before { opacity: 1; }
        .nation-card.available:active { transform: translateY(-2px) scale(1.01); box-shadow: 0 4px 10px var(--shadow-color) }
        .nation-card.selecting { opacity: .7; transform: scale(.95); transition: opacity .1s ease, transform .1s ease }
        .nation-card.disabled { opacity: .55; cursor: not-allowed; background: var(--color-disabled-bg); box-shadow: inset 0 2px 4px rgba(0, 0, 0, .1); border-color: var(--color-disabled-border); transform: none !important }
        .nation-card.disabled:hover { transform: none; box-shadow: inset 0 2px 4px rgba(0, 0, 0, .1) }
        .flag { width: 70px; height: auto; aspect-ratio: 8/5; object-fit: cover; border: 1px solid var(--color-container-border); margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; filter: sepia(10%); border-radius: 3px; box-shadow: 0 1px 2px rgba(0, 0, 0, .1); }
        @media (max-width:480px) { .flag { width: 60px; margin-bottom: 8px } }
        .nation-card.disabled .flag { filter: grayscale(95%) opacity(60%); box-shadow: none }
        .nation-card .name { font-weight: bold; /* Usa Vollkorn Regular per coerenza */ font-family: var(--font-serif); font-size: 1em; color: var(--color-text-dark); line-height: 1.3 }
        @media (max-width:480px) { .nation-card .name { font-size: .9em; } }
        .nation-tooltip { display: none; position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background-color: rgba(45, 35, 25, .95); color: var(--color-text-light); padding: 8px 12px; border-radius: var(--base-border-radius); font-size: .85em; font-family: var(--font-sans-serif); white-space: nowrap; z-index: 20; border: 1px solid var(--color-accent-light); box-shadow: 0 2px 5px rgba(0, 0, 0, .3); pointer-events: none }
        .nation-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: rgba(45, 35, 25, .95) transparent transparent transparent }
        @media (hover:none)and (pointer:coarse) { .nation-tooltip { display: none !important } .nation-card.available:hover { transform: none; box-shadow: 0 3px 7px var(--shadow-color); cursor: pointer } }
        .team-list { min-height: 100px; border: 1px dashed var(--color-accent-medium); border-radius: var(--base-border-radius); padding: 10px; margin-top: 15px; background: var(--color-list-bg); box-shadow: inset 0 1px 5px rgba(0, 0, 0, .07) }
        .team-nation { display: inline-flex; align-items: center; margin: 4px; padding: 5px 10px; background: var(--color-player-bg); border-radius: 15px; font-size: .85em; border: 1px solid var(--color-container-border); box-shadow: 0 1px 3px var(--shadow-color); transition: transform .2s ease }
        .team-nation:hover { transform: scale(1.05) }
        .team-flag { width: 18px; height: 12px; margin-right: 7px; border: 1px solid #aaa; object-fit: cover; filter: sepia(10%); border-radius: 1px; vertical-align: middle; }
        .controls { text-align: center; margin-top: 35px }
        button i.fa-solid { margin-right: 8px }
        #copy-btn { padding: 10px 15px }
        #copy-btn i.fa-solid { margin-right: 0; margin-left: 0 }
        #copy-btn span { display: none }
        #reset-btn i.fa-solid { margin-right: 6px }
        /* MODIFICA 5: Aggiustamento button */
        button {
            font-family: var(--font-serif-display); /* Usa Vollkorn */
            font-weight: 700; /* Seleziona Vollkorn Bold */
            background: linear-gradient(to bottom, var(--color-accent-medium), #6A543E);
            color: var(--color-text-light); border: 1px solid #503F2E;
            padding: 12px 24px; border-radius: 2px; cursor: pointer;
            font-size: 1em; text-transform: uppercase;
            letter-spacing: 1px; /* Ridotta spaziatura */
            transition: all var(--transition-speed) ease; margin: 6px;
            box-shadow: 0 4px 8px var(--shadow-color-darker), inset 0 1px 0 rgba(255,255,255,0.1);
            text-shadow: 1px 1px 1px rgba(0, 0, 0, .4);
        }
        @media (max-width:480px) { button { padding: 10px 18px; font-size: .95em } }
        button:hover:not(:disabled) { background: linear-gradient(to bottom, var(--color-accent-light), #7A6044); border-color: #40301E; box-shadow: 0 6px 12px var(--shadow-color-darker), inset 0 1px 1px rgba(255,255,255,0.15); transform: translateY(-3px); }
        button:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 1px 3px var(--shadow-color), inset 0 1px 3px rgba(0,0,0,0.2); }
        button:disabled { background: var(--color-disabled-bg); border-color: var(--color-disabled-border); color: var(--color-disabled-text); cursor: not-allowed; opacity: .6; box-shadow: none; text-shadow: none; transform: none }
        .login-container { text-align: center; margin: 50px auto; max-width: 400px; padding: 30px; background-color: rgba(248, 244, 232, .93); border-radius: var(--base-border-radius); box-shadow: 0 5px 25px var(--shadow-color-darker); border: 1px solid var(--color-container-border) }
        .login-container h3 { color: var(--color-text-medium); font-family: var(--font-serif-display); margin-bottom: 25px; text-transform: uppercase; font-size: 1.3em }
        input[type="text"] { padding: 12px; margin: 10px 0; border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); width: 100%; box-sizing: border-box; background-color: #FFFDF5; color: var(--color-text-dark); font-family: var(--font-serif); font-size: 1em; transition: all var(--transition-speed) ease }
        input[type="text"]:focus { border-color: var(--color-text-medium); outline: none; box-shadow: 0 0 8px rgba(90, 71, 53, .4); background-color: #fff }
        .room-info { background-color: rgba(216, 200, 168, .92); padding: 10px 15px; border-radius: var(--base-border-radius); margin-bottom: 25px; text-align: center; border: 1px solid var(--color-accent-light); font-size: .95em; color: #4e3e2d; box-shadow: inset 0 0 5px rgba(0, 0, 0, .1) }
        .room-info strong { color: var(--color-text-dark); font-weight: 700 }
        .room-info button { padding: 6px 10px; font-size: 1em; line-height: 1; margin-left: 15px; vertical-align: middle; background-color: var(--color-accent-light); border-color: var(--color-text-medium) }
        .room-info button:hover:not(:disabled) { background-color: #867767; border-color: var(--color-text-dark) }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .65); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility 0s linear .3s; padding: 20px }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity .3s ease, visibility 0s linear 0s }
        .modal-content { background-image: url('https://www.transparenttextures.com/patterns/old-paper.png'); background-color: var(--color-container-bg); padding: 35px 45px; border-radius: var(--base-border-radius); box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 2px solid var(--color-container-border); max-width: 550px; width: 95%; text-align: center; position: relative; transform: translateY(-20px) scale(.95); transition: transform .3s ease-out, opacity .3s ease-out; opacity: 0 }
        .modal-overlay.visible .modal-content { transform: translateY(0) scale(1); opacity: 1 }
        .modal-content h2 { color: var(--color-accent-dark); margin-top: 0; margin-bottom: 20px; font-family: var(--font-serif-display); font-size: 1.5em }
        .modal-content p { margin-bottom: 12px; line-height: 1.7; color: var(--color-text-dark) }
        .modal-content p small { color: var(--color-text-medium) }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: 0 0; border: none; font-size: 2.2em; color: var(--color-accent-light); cursor: pointer; padding: 0 5px; line-height: 1; transition: color var(--transition-speed) ease, transform .2s ease }
        .modal-close-btn:hover { color: var(--color-text-dark); transform: scale(1.1) }

    </style>
</head>
<body>
    <!-- Contenuto HTML (Container, Login, Game) INVARIATO -->
    <div class="container">
        <h1>Scelta Nazioni Supremacy 1914 ITA</h1>
        <div id="login-container" class="login-container">
            <h3>Accesso Ufficiali</h3>
            <input type="text" id="player-name" placeholder="Nome in codice" required>
            <select id="alliance-select" required disabled>
                <option value="" disabled selected>-- Caricamento Alleanze... --</option>
            </select>
            <input type="text" id="room-id" placeholder="ID Stanza Strategica (o lasciare vuoto)">
            <button id="join-btn" disabled><i class="fa-solid fa-right-to-bracket"></i> Entra / Crea Stanza</button>
             <p id="auth-status" style="font-size: 0.8em; margin-top: 15px; color: var(--color-text-medium);">Inizializzazione servizi...</p>
        </div>
        <div id="game-container" style="display: none; opacity: 0;">
             <div class="room-info"> Stanza: <strong id="display-room-id"></strong> | Ufficiale: <strong id="display-player-name"></strong> | Designazione: <strong id="display-player-role"></strong> <button id="copy-btn" title="Copia Collegamento Stanza"><i class="fa-solid fa-link"></i></button> </div>
             <div class="game-phase" id="game-phase"> <span class="main-phase-text">Attendere ordini...</span> <div class="hero-status" id="hero-status-p1" style="display: none;"></div> <div class="hero-status" id="hero-status-p2" style="display: none;"></div> </div>
             <div class="timer-container"> <div class="timer" id="timer"></div> <div class="timer-bar-container" id="timer-bar-container" style="display: none;"> <div class="timer-bar" id="timer-bar"></div> </div> </div>
             <div class="players-container">
                 <div class="player" id="player1"> <h2>Generale 1</h2> <div class="alliance-info" id="p1-alliance-info"> <img src="" alt="Logo Alleanza" class="alliance-logo" style="display: none;"> <span class="alliance-name"></span> </div> <div>Nazioni mobilitate: <span id="p1-count">0</span>/5</div> <div class="team-list" id="p1-team"></div> </div>
                 <div class="player" id="player2"> <h2>Generale 2</h2> <div class="alliance-info" id="p2-alliance-info"> <img src="" alt="Logo Alleanza" class="alliance-logo" style="display: none;"> <span class="alliance-name"></span> </div> <div>Nazioni mobilitate: <span id="p2-count">0</span>/5</div> <div class="team-list" id="p2-team"></div> </div>
             </div>
             <div class="nations-container" id="nations-container"> <h3>Nazioni Disponibili per l'Alleanza:</h3> <div class="nations-grid" id="nations-list"></div> </div>
             <div class="hero-selection-section" id="hero-selection-section" style="display: none;"> <h3>Decisione Schieramento Eroi</h3> <p>Confermare l'utilizzo degli Eroi per questa sfida?</p> <div class="hero-choice-buttons" id="hero-choice-buttons"> <button id="hero-yes-btn"><i class="fa-solid fa-shield-halved"></i> Schiera Eroi</button> <button id="hero-no-btn"><i class="fa-solid fa-ban"></i> Nessun Eroe</button> </div> <p id="hero-wait-message" style="display: none; margin-top: 15px; font-style: italic;">Decisione registrata. Attendere l'avversario...</p> </div>
             <div class="summary-section" id="summary-section" style="display: none;">
                 <h3>Riepilogo Finale Selezione</h3>
                 <div class="summary-details">
                     <div class="summary-player" id="summary-p1"> <h4>Generale 1: <span id="summary-p1-name"></span></h4> <div class="summary-alliance"> <strong>Alleanza:</strong> <img src="" alt="" class="summary-alliance-logo alliance-logo" style="display: none;"> <span id="summary-p1-alliance-name"></span> </div> <strong>Nazioni:</strong> <ul id="summary-p1-nations"></ul> <strong>Eroi:</strong> <span class="hero-decision" id="summary-p1-hero"></span> </div>
                     <div class="summary-player" id="summary-p2"> <h4>Generale 2: <span id="summary-p2-name"></span></h4> <div class="summary-alliance"> <strong>Alleanza:</strong> <img src="" alt="" class="summary-alliance-logo alliance-logo" style="display: none;"> <span id="summary-p2-alliance-name"></span> </div> <strong>Nazioni:</strong> <ul id="summary-p2-nations"></ul> <strong>Eroi:</strong> <span class="hero-decision" id="summary-p2-hero"></span> </div>
                 </div>
                 <button id="download-pdf-btn" style="margin-top: 25px;"><i class="fa-solid fa-file-pdf"></i> Scarica Riepilogo (PDF)</button>
            </div>
            <div class="controls"> <button id="reset-btn"><i class="fa-solid fa-flag"></i> Ritirata</button> </div>
        </div>
    </div>
    <div id="thank-you-modal" class="modal-overlay" style="display: none;"> <div class="modal-content"> <button class="modal-close-btn" id="modal-close-btn" title="Chiudi">×</button> <h2>Selezione Completata!</h2> <p>Lo Staff Supremacy 1914 - 2025 ti ringrazia per la collaborazione e augura a tutta la squadra una buona sfida!</p> <p><small>(Il riepilogo PDF è stato scaricato.)</small></p> </div> </div>

    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyBMSMS7TCBVATqdoCqNX99AriyiSpy9y8E", authDomain: "supremacy-web.firebaseapp.com", databaseURL: "https://supremacy-web-default-rtdb.europe-west1.firebasedatabase.app", projectId: "supremacy-web", storageBucket: "supremacy-web.appspot.com", messagingSenderId: "30781020744", appId: "1:30781020744:web:81eee78242a060a9d6167d", measurementId: "G-VTMYEXEDSW" };

        // --- Variabili Globali ---
        let database; let auth; let isAuthComplete = false; let localGameState = {};
        let playerRole = null; let playerName = ""; let roomId = ""; let timerInterval = null;
        let roomRef = null; let turnStartTime = 0;
        let timerDuration = 3600000; // 1 ORA - Forse da ridurre? Es: 180000 per 3 minuti
        let audioUnlocked = false; let sounds = {};

        // --- Array e Costanti ---
        const { jsPDF } = window.jspdf;
        const allNations = [ { id: 1, name: "Marocco", code: "ma", bonus: "Posizione strategica", description: "Crocevia tra Africa ed Europa" }, { id: 2, name: "Spagna", code: "es", bonus: "Esplorazione +10%", description: "Terra di conquistadores" }, { id: 3, name: "Francia", code: "fr", bonus: "Diplomazia +15%", description: "Terra di rivoluzioni e vino" }, { id: 4, name: "Gran Bretagna", code: "gb", bonus: "Commercio +15%", description: "Impero marittimo storico" }, { id: 5, name: "Germania", code: "de", bonus: "Produzione +20%", description: "Potenza industriale europea" }, { id: 6, name: "Italia", code: "it", bonus: "Cultura +10%", description: "Patria dell'arte e della cucina" }, { id: 7, name: "Austria", code: "at", bonus: "Musica +10%", description: "Cuore dell'Europa centrale" }, { id: 8, name: "Impero Ottomano", code: "tr", bonus: "Posizione +15%", description: "Crocevia tra continenti" }, { id: 9, name: "Russia", code: "ru", bonus: "Territorio +25%", description: "Vasta nazione euroasiatica" }, { id: 10, name: "Svezia", code: "se", bonus: "Innovazione +10%", description: "Terra di tecnologia e natura" } ];
        const loadedAlliances = [ { "id": 1, "name": "BATTAGLIONE WOLF", "logo_path": "images/logos/BATTAGLIONE WOLF.jpg" }, { "id": 2, "name": "BOHEMIANS", "logo_path": "images/logos/BOHEMIANS.jpg" }, { "id": 3, "name": "GLI ONOREVOLI PICCHIATORI", "logo_path": "images/logos/GLI ONOREVOLI PICCHIATORI.jpeg" }, { "id": 4, "name": "GRANDE ALLEANZA SUPREMA", "logo_path": "images/logos/GRANDE ALLEANZA SUPREMA.jpg" }, { "id": 5, "name": "I CADETTI", "logo_path": "images/logos/I CADETTI.jpg" }, { "id": 6, name: "I PENETRATORI", "logo_path": "images/logos/I PENETRATORI.jpg" }, { "id": 7, name: "I RIBELLI DELLA MONTAGNA", "logo_path": "images/logos/I RIBELLI DELLA MONTAGNA.jpg" }, { "id": 8, name: "INTOCCABILI", "logo_path": "images/logos/INTOCCABILI.jpg" }, { "id": 9, name: "NONA INVCTA", "logo_path": "images/logos/NONA INVCTA.jpg" }, { "id": 10, name: "ORDINE DEGLI HASHASHIN", "logo_path": "images/logos/ORDINE DEGLI HASHASHIN.jpg" }, { "id": 11, name: "ORDINE SUPREMO DELLE AQUILE", "logo_path": "images/logos/ORDINE SUPREMO DELLE AQUILE.jpg" }, { "id": 12, name: "PATTO DEL MARE DEL NORD", "logo_path": "images/logos/PATTO DEL MARE DEL NORD.jpg" }, { "id": 13, name: "REGGIMENTO ARDITI", "logo_path": "images/logos/REGGIMENTO ARDITI.jpg" }, { "id": 14, name: "SOUTH WARRIORS", "logo_path": "images/logos/SOUTH WARRIORS.jpg" }, { "id": 15, name: "SPARTAN SOLDIERS", "logo_path": "images/logos/SPARTAN SOLDIERS.jpg" }, { "id": 16, name: "SPREGIUDICATI", "logo_path": "images/logos/SPREGIUDICATI.jpg" } ];
        const soundFiles = { click: 'sounds/click.mp3', turn: 'sounds/turn.mp3', heroYes: 'sounds/hero_yes.mp3', heroNo: 'sounds/hero_no.mp3', error: 'sounds/error.mp3', complete: 'sounds/complete.mp3' };

        // --- ESEGUI TUTTO DOPO IL CARICAMENTO DEL DOM E DEGLI SDK ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Caricato. Inizio script.");

            // --- Elementi DOM ---
            // (Ottenimento elementi DOM invariato)
            const loginContainer = document.getElementById('login-container');
            const gameContainer = document.getElementById('game-container');
            const playerNameInput = document.getElementById('player-name');
            const roomIdInput = document.getElementById('room-id');
            const allianceSelect = document.getElementById('alliance-select');
            const joinBtn = document.getElementById('join-btn');
            const displayRoomId = document.getElementById('display-room-id');
            const displayPlayerName = document.getElementById('display-player-name');
            const displayPlayerRole = document.getElementById('display-player-role');
            const nationsListEl = document.getElementById('nations-list');
            const p1TeamEl = document.getElementById('p1-team');
            const p2TeamEl = document.getElementById('p2-team');
            const p1CountEl = document.getElementById('p1-count');
            const p2CountEl = document.getElementById('p2-count');
            const gamePhaseEl = document.getElementById('game-phase');
            const timerEl = document.getElementById('timer');
            const player1El = document.getElementById('player1');
            const player2El = document.getElementById('player2');
            const resetBtn = document.getElementById('reset-btn');
            const copyBtn = document.getElementById('copy-btn');
            const nationsContainer = document.getElementById('nations-container');
            const heroSelectionSection = document.getElementById('hero-selection-section');
            const heroChoiceButtons = document.getElementById('hero-choice-buttons');
            const heroYesBtn = document.getElementById('hero-yes-btn');
            const heroNoBtn = document.getElementById('hero-no-btn');
            const heroWaitMessage = document.getElementById('hero-wait-message');
            const summarySection = document.getElementById('summary-section');
            const heroStatusP1 = document.getElementById('hero-status-p1');
            const heroStatusP2 = document.getElementById('hero-status-p2');
            const timerBarContainer = document.getElementById('timer-bar-container');
            const timerBar = document.getElementById('timer-bar');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const thankYouModal = document.getElementById('thank-you-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const authStatusEl = document.getElementById('auth-status');


            // --- Inizializzazione Firebase e Autenticazione ---
            // (Invariato)
            try {
                if (typeof firebase === 'undefined') throw new Error("Firebase SDK non caricato.");
                if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); console.log("Firebase App Inizializzata."); }
                else { firebase.app(); console.log("Firebase App già inizializzata."); }
                database = firebase.database(); auth = firebase.auth();
                console.log("Avvio autenticazione anonima...");
                if (authStatusEl) authStatusEl.textContent = "Autenticazione...";

                auth.signInAnonymously()
                  .then(() => {
                    const user = auth.currentUser; console.log("Auth anonima RIUSCITA. UID:", user ? user.uid : 'N/D');
                    isAuthComplete = true; if (authStatusEl) { authStatusEl.textContent = "Servizi pronti."; authStatusEl.style.color = "darkgreen"; }
                    setupApplication(); // Avvia logica app DOPO auth
                  })
                  .catch((error) => { console.error("!!! ERRORE CRITICO Auth Anonima:", error); if (authStatusEl) { authStatusEl.textContent = `Errore Auth: ${error.message}`; authStatusEl.style.color = "red"; } alert(`Errore auth (${error.code}). Impossibile continuare.`); if (joinBtn) joinBtn.disabled = true; });

                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", (snap) => { const currentName = typeof playerName === 'string' && playerName !== "" ? playerName : 'N/A'; const currentRole = typeof playerRole === 'number' ? playerRole : '?'; const logPrefix = `[${currentName} - P${currentRole}]`; if (snap.val() === true) { console.log(`${logPrefix} Connesso a Firebase.`); } else { if (currentName !== 'N/A') { console.warn(`${logPrefix} Disconnesso da Firebase.`); } else { console.log(`[N/A - P?] Stato connessione: Disconnesso.`); } } });

            } catch (e) { console.error("ERRORE Init Firebase:", e); alert("Errore Init Firebase: " + e.message); if (authStatusEl) { authStatusEl.textContent = "Errore Init Critico!"; authStatusEl.style.color = "red"; } }


            // --- DEFINIZIONI FUNZIONI (Logica JS invariata) ---
            // (Tutte le funzioni JS: initializeAudio, unlockAudioContext, playSound, ...)
            // (... getAllianceById, generateRoomId, handleJoinClick, joinRoom, resetLoginUI, ...)
            // (... initializeGameView, initializeGame, listenToRoomChanges, startDraft, ...)
            // (... updateUI, startTimer, skipTurn, selectNationWithAnimation, selectNation, ...)
            // (... handleHeroChoice, generateAndDownloadPDF, getHeroStatusText, populateSummary, ...)
            // (... renderTeams, renderNations, updateGamePhaseDisplay, handleGameEndCleanup, ...)
            // (... handleCopyClick, handleResetClick, handleModalClose, handleModalOverlayClick, ...)
            // (... handleDownloadPdfClick, setupApplication)
            // RIMANGONO IDENTICHE ALLA VERSIONE PRECEDENTE
            function initializeAudio() { console.log("Init Audio..."); for (const key in soundFiles) { try { const audio = new Audio(soundFiles[key]); audio.preload = 'auto'; audio.load(); audio.volume = 0.6; sounds[key] = audio; } catch (e) { console.error(`Errore Audio ${key}:`, e); } } document.body.addEventListener('pointerup', unlockAudioContext, { once: true }); console.log("Listener audio aggiunto.");}
            function unlockAudioContext() { if (audioUnlocked) return; console.log("Sblocco Audio..."); const context = new (window.AudioContext || window.webkitAudioContext)(); if (context.state === 'suspended') { context.resume(); } const soundToUnlock = sounds['click'] || Object.values(sounds)[0]; if (soundToUnlock) { soundToUnlock.play().then(() => { soundToUnlock.pause(); soundToUnlock.currentTime = 0; audioUnlocked = true; console.log("Audio sbloccato."); }).catch(error => { console.warn("Sblocco audio fallito:", error); audioUnlocked = true; }); } else { console.warn("Nessun suono per sblocco."); audioUnlocked = true; } document.body.removeEventListener('pointerup', unlockAudioContext); }
            function playSound(soundName) { const sound = sounds[soundName]; if (sound && audioUnlocked) { sound.currentTime = 0; sound.play().catch(e => console.warn(`Errore play ${soundName}:`, e)); } else if (!sound) { console.warn(`Suono non trovato: ${soundName}`); } else if (!audioUnlocked) { console.warn(`Audio non sbloccato: ${soundName}`); unlockAudioContext(); } }
            function getAllianceById(id) { const numericId = parseInt(id); if (isNaN(numericId)) return null; return loadedAlliances.find(a => a.id === numericId); }
            function generateRoomId() { return Math.random().toString(36).substring(2, 6).toUpperCase(); }
            function handleJoinClick() { if (!isAuthComplete) { alert("Auth non completata."); return; } playSound('click'); playerName = playerNameInput.value.trim(); let potentialRoomId = roomIdInput.value.trim().toUpperCase(); const selectedAllianceId = allianceSelect ? allianceSelect.value : ""; if (!playerName) { alert("Nome mancante."); playSound('error'); return; } if (!selectedAllianceId) { alert("Alleanza mancante."); playSound('error'); return; } if (!database) { alert("Errore DB."); playSound('error'); return; } joinBtn.disabled = true; allianceSelect.disabled = true; playerNameInput.disabled = true; roomIdInput.disabled = true; if (!potentialRoomId) { roomId = generateRoomId(); playerRole = 1; console.log(`Creo stanza ${roomId} P1 (${playerName})`); initializeGame(selectedAllianceId); } else { roomId = potentialRoomId; console.log(`Join stanza ${roomId} (${playerName})`); joinRoom(selectedAllianceId); } }
            function joinRoom(selectedAllianceId) { if (!database || !isAuthComplete) { alert("Errore Servizi."); resetLoginUI(); return; } const checkRoomRef = database.ref(`rooms/${roomId}`); checkRoomRef.once('value').then(snapshot => { if (snapshot.exists()) { const roomData = snapshot.val() || {}; const p1Data = roomData.player1 || {}; const p2Data = roomData.player2 || {}; const p1Exists = !!p1Data.name; const p2Exists = !!p2Data.name; const currentUser = auth.currentUser; if (p1Exists && p1Data.name === playerName && (!p1Data.uid || (currentUser && p1Data.uid === currentUser.uid))) { console.log("Riconnesso P1."); playSound('turn'); playerRole = 1; initializeGameView(); listenToRoomChanges(); return; } if (p2Exists && p2Data.name === playerName && (!p2Data.uid || (currentUser && p2Data.uid === currentUser.uid))) { console.log("Riconnesso P2."); playSound('turn'); playerRole = 2; initializeGameView(); listenToRoomChanges(); return; } if (!p1Exists) { playerRole = 1; console.log(`Unito P1.`); } else if (!p2Exists) { playerRole = 2; console.log(`Unito P2.`); } else { alert("Stanza piena!"); playSound('error'); resetLoginUI(); return; } initializeGame(selectedAllianceId); } else { alert("Stanza non trovata!"); playSound('error'); resetLoginUI(); } }).catch(e => { if (e.code === 'PERMISSION_DENIED') { console.error("PERMISSION_DENIED lettura stanza:", e); alert("Errore Permesso Lettura Stanza."); } else { console.error("Errore generico verifica stanza:", e); alert("Errore connessione stanza: " + e.message); } playSound('error'); resetLoginUI(); }); }
            function resetLoginUI() { roomId = ""; if (roomRef) { roomRef.off("value"); roomRef = null; } playerRole = null; playerName = ""; localGameState = {}; if(joinBtn) joinBtn.disabled = true; if (allianceSelect) { allianceSelect.value = ""; allianceSelect.disabled = false; if (allianceSelect.options.length > 0 && allianceSelect.options[0].disabled) { allianceSelect.selectedIndex = 0; } } if(roomIdInput) { roomIdInput.value = ''; roomIdInput.disabled = false; } if(playerNameInput) { playerNameInput.value = ''; playerNameInput.disabled = false; } if(loginContainer) loginContainer.style.display = 'block'; if(gameContainer) { gameContainer.style.display = 'none'; gameContainer.style.opacity = '0'; } const checkLoginInputs = () => { if (!playerNameInput || !allianceSelect || !joinBtn) return; const nameFilled = playerNameInput.value.trim().length > 0; const allianceSelected = allianceSelect.value !== ""; joinBtn.disabled = !(nameFilled && allianceSelected && isAuthComplete); }; checkLoginInputs(); console.log("UI resettata login."); }
            function initializeGameView() { if(loginContainer) loginContainer.style.display = 'none'; if(gameContainer) { gameContainer.style.display = 'block'; setTimeout(() => { gameContainer.style.opacity = '1'; }, 50); } if(displayRoomId) displayRoomId.textContent = roomId; if(displayPlayerName) displayPlayerName.textContent = playerName; if(displayPlayerRole) displayPlayerRole.textContent = `Generale ${playerRole}`; if (window.history.replaceState) { const cleanUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?room=${roomId}`; try { window.history.replaceState({ path: cleanUrl }, '', cleanUrl); } catch (e) { console.warn("Impossibile aggiornare URL:", e); } } }
            function initializeGame(selectedAllianceId) { if (!database || !isAuthComplete) { alert("Errore Servizi."); resetLoginUI(); return; } const user = auth.currentUser; if (!user) { console.error("ERRORE CRITICO: No user per init game!"); alert("Errore auth."); resetLoginUI(); return; } initializeGameView(); const updates = {}; const playerPath = `/rooms/${roomId}/player${playerRole}`; updates[`${playerPath}/name`] = playerName; updates[`${playerPath}/team`] = []; updates[`${playerPath}/heroChoice`] = null; updates[`${playerPath}/allianceId`] = parseInt(selectedAllianceId); updates[`${playerPath}/uid`] = user.uid; const roomBaseRef = database.ref(`/rooms/${roomId}`); roomBaseRef.once('value').then(snapshot => { const roomData = snapshot.val() || {}; if (playerRole === 1 && !roomData.gamePhase) { updates[`/rooms/${roomId}/gamePhase`] = "waiting"; updates[`/rooms/${roomId}/currentPlayer`] = null; updates[`/rooms/${roomId}/timerEnd`] = null; console.log("Stato iniziale stanza impostato da P1."); } const logPrefix = `[${playerName} - P${playerRole}]`; console.log(`${logPrefix} Init Game - Updates:`, JSON.stringify(updates, null, 2)); database.ref().update(updates).then(() => { console.log(`Dati init P${playerRole} salvati (UID: ${user.uid}).`); listenToRoomChanges(); }).catch(error => { console.error(`${logPrefix} Errore salvataggio dati init:`, error); alert("Errore init stanza: " + error.message); playSound('error'); handleGameEndCleanup(); }); }).catch(error => { console.error(`${logPrefix} Errore verifica stanza per init:`, error); alert("Errore verifica stanza: " + error.message); playSound('error'); handleGameEndCleanup(); }); }
            function listenToRoomChanges() { if (!database || !isAuthComplete) { console.error("DB o Auth non pronti per listenToRoomChanges"); return; } if (roomRef) { roomRef.off("value"); console.log("Listener precedente rimosso."); } roomRef = database.ref(`rooms/${roomId}`); const logPrefixFunc = () => `[${playerName || 'N/A'} - P${playerRole || '?'}]`; console.log(`${logPrefixFunc()} In ascolto su rooms/${roomId}`); roomRef.on('value', snapshot => { const currentLogPrefix = logPrefixFunc(); const user = auth.currentUser; console.log(`${currentLogPrefix} Listener 'value' ATTIVATO. Auth user:`, user ? user.uid : 'NESSUNO'); if (!snapshot.exists()) { if (gameContainer && gameContainer.style.display !== 'none') { alert("Stanza Chiusa."); playSound('error'); handleGameEndCleanup(); } return; } const roomData = snapshot.val(); if (!roomData || typeof roomData !== 'object') { console.warn(`${currentLogPrefix} Dati stanza non validi:`, roomData); return; } console.log(`${currentLogPrefix} Dati ricevuti FB:`, JSON.stringify(roomData, null, 2)); const previousPlayer = localGameState.currentPlayer; const previousPhase = localGameState.gamePhase; const p1Data = roomData.player1 || { name: "", team: [], heroChoice: null, allianceId: null, uid: null }; const p2Data = roomData.player2 || { name: "", team: [], heroChoice: null, allianceId: null, uid: null }; const normalizeTeam = (team) => (!team ? [] : (Array.isArray(team) ? team : Object.values(team))); localGameState = { player1: { name: p1Data.name || "", team: normalizeTeam(p1Data.team), heroChoice: p1Data.heroChoice, allianceId: p1Data.allianceId || null, uid: p1Data.uid }, player2: { name: p2Data.name || "", team: normalizeTeam(p2Data.team), heroChoice: p2Data.heroChoice, allianceId: p2Data.allianceId || null, uid: p2Data.uid }, currentPlayer: roomData.currentPlayer !== undefined ? roomData.currentPlayer : null, gamePhase: roomData.gamePhase || "waiting", timerEnd: roomData.timerEnd || null }; console.log(`${currentLogPrefix} Stato Locale Aggiornato:`, JSON.stringify(localGameState, null, 2)); updateUI(); const p1Ready = !!localGameState.player1?.name && !!localGameState.player1?.uid; const p2Ready = !!localGameState.player2?.name && !!localGameState.player2?.uid; console.log(`${currentLogPrefix} Check Start Draft: Role=${playerRole}, Phase=${localGameState.gamePhase}, P1Ready=${p1Ready}, P2Ready=${p2Ready}`); if (playerRole === 1 && localGameState.gamePhase === "waiting" && p1Ready && p2Ready) { console.log(`${currentLogPrefix} CONDIZIONE START DRAFT VALIDA -> Chiamo startDraft()`); startDraft(); } if (localGameState.gamePhase === 'draft' && localGameState.currentPlayer !== previousPlayer && localGameState.currentPlayer !== null) { if (localGameState.currentPlayer === playerRole) { playSound('turn'); } const el = document.getElementById(`player${localGameState.currentPlayer}`); if (el) { el.classList.remove('turn-pulse'); void el.offsetWidth; el.classList.add('turn-pulse'); setTimeout(() => el.classList.remove('turn-pulse'), 600); } } if ((localGameState.gamePhase === 'hero_selection' && (previousPhase === 'draft' || previousPhase === 'completed')) || (localGameState.gamePhase === 'summary' && previousPhase === 'hero_selection')) { playSound('complete'); } if (localGameState.gamePhase === "draft" && localGameState.timerEnd) { startTimer(); } else { clearInterval(timerInterval); timerInterval = null; if(timerEl) timerEl.textContent = ''; if(timerBarContainer) timerBarContainer.style.display = 'none'; } }, errorObject => { console.error(`${logPrefixFunc()} Errore Firebase Listener:`, errorObject); alert("Errore connessione: " + errorObject.message); playSound('error'); handleGameEndCleanup(); }); }
            function startDraft() { const logPrefix = `[${playerName} - P${playerRole || '?'}]`; console.log(`${logPrefix} ESECUZIONE startDraft() INIZIATA`); if (!database || !roomId || playerRole !== 1 || localGameState.gamePhase !== 'waiting') { console.warn(`${logPrefix} startDraft BLOCCATO: Condizioni preliminari.`); return; } if (!localGameState.player1?.name || !localGameState.player2?.name || !localGameState.player1?.uid || !localGameState.player2?.uid) { console.warn(`${logPrefix} startDraft BLOCCATO: Dati giocatori non pronti.`); return; } console.log(`${logPrefix} startDraft: Condizioni valide. Preparo update...`); const updates = {}; updates[`/rooms/${roomId}/gamePhase`] = "draft"; updates[`/rooms/${roomId}/currentPlayer`] = 1; turnStartTime = Date.now(); updates[`/rooms/${roomId}/timerEnd`] = turnStartTime + timerDuration; console.log(`${logPrefix} startDraft: Updates da inviare:`, JSON.stringify(updates, null, 2)); database.ref().update(updates).then(() => { console.log(`${logPrefix} startDraft SUCCESSO: Fase draft aggiornata FB.`); }).catch(error => { console.error(`${logPrefix} ERRORE startDraft update Firebase:`, error); alert(`Errore avvio gioco: ${error.message}.`); }); }
            function updateUI() { const currentPhase = localGameState.gamePhase; const logPrefix = `[${playerName || 'N/A'} - P${playerRole || '?'}]`; const updatePlayerInfo = (pNum, pState) => { const pEl=document.getElementById(`player${pNum}`); if(!pEl) return; const alliInfo=document.getElementById(`p${pNum}-alliance-info`), logoEl=alliInfo?alliInfo.querySelector('.alliance-logo'):null, nameEl=alliInfo?alliInfo.querySelector('.alliance-name'):null, titleEl=pEl.querySelector('h2'); if(titleEl) titleEl.textContent=`Generale ${pNum}: ${pState?.name||'(Attendere)'}`; if(alliInfo&&logoEl&&nameEl){ const aId=pState?.allianceId; const alli=aId?getAllianceById(aId):null; if(alli){ logoEl.src=alli.logo_path||""; logoEl.alt=alli.name?`Logo ${alli.name}`:"Logo"; logoEl.style.display=alli.logo_path?'inline-block':'none'; nameEl.textContent=alli.name; } else { logoEl.style.display='none'; logoEl.src=""; nameEl.textContent=aId?'ID:'+aId:''; } } }; updatePlayerInfo(1, localGameState.player1); updatePlayerInfo(2, localGameState.player2); if(player1El) player1El.classList.toggle('active', localGameState.currentPlayer === 1 && currentPhase === "draft"); if(player2El) player2El.classList.toggle('active', localGameState.currentPlayer === 2 && currentPhase === "draft"); renderTeams(); updateGamePhaseDisplay(); renderNations(); const showNations=(currentPhase==='draft'); const showHero=(currentPhase==='hero_selection'); const showSummary=(currentPhase==='summary'); if(nationsContainer) nationsContainer.style.display=showNations?'block':'none'; if(heroSelectionSection) heroSelectionSection.style.display=showHero?'block':'none'; if(summarySection) summarySection.style.display=showSummary?'block':'none'; if(currentPhase==='hero_selection'){ const myC=localGameState[`player${playerRole}`]?.heroChoice; const oppR=playerRole===1?2:1; const oppC=localGameState[`player${oppR}`]?.heroChoice; const iHaveChosen=myC!==null&&myC!==undefined; const oppHasChosen=oppC!==null&&oppC!==undefined; if(heroYesBtn&&heroNoBtn){ heroYesBtn.disabled=iHaveChosen; heroNoBtn.disabled=iHaveChosen; heroYesBtn.classList.toggle('selected',myC===true); heroNoBtn.classList.toggle('selected',myC===false); } if(heroWaitMessage){ heroWaitMessage.style.display=(iHaveChosen&&!oppHasChosen)?'block':'none'; } if(heroChoiceButtons){ heroChoiceButtons.style.display='block'; } } else { if(heroChoiceButtons) heroChoiceButtons.style.display='none'; if(heroWaitMessage) heroWaitMessage.style.display='none'; if(heroYesBtn){ heroYesBtn.classList.remove('selected'); heroYesBtn.disabled=false; } if(heroNoBtn){ heroNoBtn.classList.remove('selected'); heroNoBtn.disabled=false; } } if(currentPhase==='summary'){ populateSummary(); if(downloadPdfBtn){ downloadPdfBtn.style.display='inline-block'; downloadPdfBtn.disabled=false; } if(thankYouModal&&thankYouModal.classList.contains('visible')){ modalCloseBtn.click(); } } else { if(downloadPdfBtn) downloadPdfBtn.style.display='none'; } if(resetBtn){ resetBtn.disabled=!roomId; resetBtn.style.display=(currentPhase==='summary'||(thankYouModal&&thankYouModal.classList.contains('visible')))?'none':'inline-block'; } if(copyBtn){ copyBtn.disabled=!roomId; } }
            function startTimer() { clearInterval(timerInterval); if (!localGameState.timerEnd || localGameState.gamePhase !== 'draft') { if(timerEl) timerEl.textContent = ''; if(timerBarContainer) timerBarContainer.style.display = 'none'; return; } if(timerBarContainer) timerBarContainer.style.display = 'block'; const updateTimerDisplay = () => { const now = Date.now(); const endTime = localGameState.timerEnd; const timeLeft = Math.max(0, endTime - now); if (timeLeft === 0) { clearInterval(timerInterval); timerInterval = null; if(timerEl) timerEl.textContent = "00:00"; if(timerBar) timerBar.style.width = '0%'; console.log("Tempo scaduto."); return; } const minutes = Math.floor(timeLeft / 60000); const seconds = Math.floor((timeLeft % 60000) / 1000); if(timerEl) timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; const percentageLeft = Math.max(0, (timeLeft / timerDuration) * 100); if(timerBar) timerBar.style.width = `${percentageLeft}%`; }; updateTimerDisplay(); timerInterval = setInterval(updateTimerDisplay, 1000); }
            function skipTurn() { console.warn("Funzione skipTurn non implementata"); }
            function selectNationWithAnimation(cardElement, nation) { cardElement.classList.add('selecting'); setTimeout(() => { selectNation(nation); }, 100); }
            function selectNation(nation) { if (!database || !roomId || !playerRole || !localGameState || !isAuthComplete) return; const logPrefix = `[${playerName} - P${playerRole}]`; const currentPlayerState = localGameState[`player${playerRole}`]; const currentTeam = currentPlayerState?.team || []; if (localGameState.gamePhase !== "draft") { console.warn(`${logPrefix} SelectNation: Fase errata (${localGameState.gamePhase})`); playSound('error'); return; } if (localGameState.currentPlayer !== playerRole) { console.warn(`${logPrefix} SelectNation: Non mio turno.`); playSound('error'); return; } if (currentTeam.length >= 5) { console.warn(`${logPrefix} SelectNation: Squadra piena.`); playSound('error'); return; } const allSelectedIds = new Set([...(localGameState.player1?.team || []), ...(localGameState.player2?.team || [])]); if (allSelectedIds.has(nation.id)) { console.warn(`${logPrefix} SelectNation: Nazione già scelta.`); playSound('error'); return; } playSound('click'); const playerPath = `/rooms/${roomId}/player${playerRole}`; const updates = {}; const nextTeam = [...currentTeam, nation.id]; updates[`${playerPath}/team`] = nextTeam; const nextPlayer = playerRole === 1 ? 2 : 1; const p1TeamSize = (playerRole === 1 ? nextTeam.length : (localGameState.player1?.team?.length || 0)); const p2TeamSize = (playerRole === 2 ? nextTeam.length : (localGameState.player2?.team?.length || 0)); if (p1TeamSize >= 5 && p2TeamSize >= 5) { console.log(`${logPrefix} SelectNation: Draft completato! -> hero_selection.`); updates[`/rooms/${roomId}/gamePhase`] = "hero_selection"; updates[`/rooms/${roomId}/currentPlayer`] = null; updates[`/rooms/${roomId}/timerEnd`] = null; updates[`/rooms/${roomId}/player1/heroChoice`] = null; updates[`/rooms/${roomId}/player2/heroChoice`] = null; playSound('complete'); } else { console.log(`${logPrefix} SelectNation: -> P${nextPlayer}.`); updates[`/rooms/${roomId}/currentPlayer`] = nextPlayer; turnStartTime = Date.now(); updates[`/rooms/${roomId}/timerEnd`] = turnStartTime + timerDuration; } console.log(`${logPrefix} SelectNation: Updates:`, JSON.stringify(updates)); database.ref().update(updates).then(() => console.log(`${logPrefix} SelectNation: ${nation.name} sel.`)).catch(error => { console.error(`${logPrefix} SelectNation Errore:`, error); alert("Errore: " + error.message); playSound('error'); }); }
            function handleHeroChoice(choice) { if (!database || !roomId || !playerRole || localGameState.gamePhase !== 'hero_selection' || !isAuthComplete) { playSound('error'); return; } const logPrefix = `[${playerName} - P${playerRole}]`; const playerPath = `/rooms/${roomId}/player${playerRole}`; const myCurrentChoice = localGameState[`player${playerRole}`]?.heroChoice; if (myCurrentChoice !== null && myCurrentChoice !== undefined) { console.warn(`${logPrefix} HeroChoice: Già scelto.`); return; } playSound(choice ? 'heroYes' : 'heroNo'); if(heroYesBtn) heroYesBtn.disabled = true; if(heroNoBtn) heroNoBtn.disabled = true; if(heroYesBtn) heroYesBtn.classList.toggle('selected', choice === true); if(heroNoBtn) heroNoBtn.classList.toggle('selected', choice === false); if(heroWaitMessage) heroWaitMessage.style.display = 'block'; const updates = {}; updates[`${playerPath}/heroChoice`] = choice; const opponentRole = playerRole === 1 ? 2 : 1; const opponentChoice = localGameState[`player${opponentRole}`]?.heroChoice; console.log(`${logPrefix} HeroChoice: Mia=${choice}, Opponent=${opponentChoice}`); if (opponentChoice !== null && opponentChoice !== undefined) { console.log(`${logPrefix} HeroChoice: Entrambi scelti. -> summary.`); updates[`/rooms/${roomId}/gamePhase`] = "summary"; updates[`/rooms/${roomId}/currentPlayer`] = null; updates[`/rooms/${roomId}/timerEnd`] = null; playSound('complete'); } else { console.log(`${logPrefix} HeroChoice: Attendo avversario.`); } database.ref().update(updates).then(() => console.log(`${logPrefix} HeroChoice: Scelta ${choice} salvata.`)).catch(error => { console.error(`${logPrefix} HeroChoice Errore:`, error); alert("Errore: " + error.message); playSound('error'); if(heroYesBtn) heroYesBtn.disabled = false; if(heroNoBtn) heroNoBtn.disabled = false; if(heroYesBtn) heroYesBtn.classList.remove('selected'); if(heroNoBtn) heroNoBtn.classList.remove('selected'); if(heroWaitMessage) heroWaitMessage.style.display = 'none'; }); }
            function generateAndDownloadPDF() { console.log("Genero PDF..."); if (typeof jsPDF === 'undefined') { alert("Errore PDF lib."); playSound('error'); if(downloadPdfBtn) downloadPdfBtn.disabled=false; return; } if (!localGameState?.player1 || !localGameState?.player2 || !roomId) { alert("Errore dati PDF."); playSound('error'); if(downloadPdfBtn) downloadPdfBtn.disabled=false; return; } try { const doc = new jsPDF(); const getNation = (id) => allNations.find(n => n.id === id); const getHeroText = (c) => (c === true ? 'Si' : (c === false ? 'No' : 'N/D')); let y = 15; const ls = 8; const ss = 12; const lm = 15; const co = 110; doc.setFontSize(18); try { doc.setFont('Vollkorn', 'bold'); /* Usa Vollkorn per H1 nel PDF */ } catch(e) { doc.setFont('helvetica', 'bold'); } doc.text("Riepilogo Selezione Supremacy 1914 ITA", doc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += ss; doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.text(`Stanza: ${roomId}`, lm, y); const now = new Date(); doc.text(`Data: ${now.toLocaleDateString('it-IT')} ${now.toLocaleTimeString('it-IT')}`, co, y); y += ss; doc.setLineWidth(0.3); doc.line(lm, y - ss / 2, doc.internal.pageSize.getWidth() - lm, y - ss / 2); const drawPlayerSection = (playerNum, playerState) => { if (!playerState || !playerState.name) { doc.setFontSize(14); try { doc.setFont('Vollkorn', 'bold'); /* Usa Vollkorn per H4 */ } catch(e) { doc.setFont('helvetica', 'bold'); } doc.text(`Generale ${playerNum}: (Non Presente)`, lm, y); y += ss * 1.5; return; } doc.setFontSize(14); try { doc.setFont('Vollkorn', 'bold'); /* Usa Vollkorn per H4 */ } catch(e) { doc.setFont('helvetica', 'bold'); } doc.text(`Generale ${playerNum}: ${playerState.name}`, lm, y); y += ls; doc.setFontSize(10); doc.setFont('helvetica', 'normal'); const allianceId = playerState.allianceId; const alliance = allianceId ? getAllianceById(allianceId) : null; const allianceText = `Alleanza: ${alliance ? alliance.name : (allianceId ? 'ID:'+allianceId : 'N/D')}`; doc.text(allianceText, lm, y); y += ls * 1.5; doc.setFontSize(11); doc.setFont('helvetica', 'bold'); doc.text("Nazioni:", lm, y); y += ls; doc.setFont('helvetica', 'normal'); const team = playerState.team || []; if (team.length === 0) { doc.text("- Nessuna", lm + 5, y); y += ls; } else { team.forEach((id, i) => { const nation = getNation(id); const currentY = y; const textX = lm + 5; if (nation) { doc.text(`${i + 1}. ${nation.name}`, textX, currentY); } else { doc.text(`${i + 1}. ID Sconosciuto: ${id}`, textX, currentY); } y += ls; }); } y += ls / 2; doc.setFont('helvetica', 'bold'); doc.text(`Eroi: ${getHeroText(playerState.heroChoice)}`, lm, y); y += ss * 1.5; }; drawPlayerSection(1, localGameState.player1); drawPlayerSection(2, localGameState.player2); const fn = `Riepilogo_${roomId}_${now.toISOString().split('T')[0]}.pdf`; doc.save(fn); console.log("PDF generato:", fn); playSound('complete'); if (thankYouModal) { thankYouModal.style.display = 'flex'; void thankYouModal.offsetWidth; thankYouModal.classList.add('visible'); } else { alert("Selezione Completata!"); } if (downloadPdfBtn) downloadPdfBtn.style.display = 'none'; if (resetBtn) resetBtn.style.display = 'none'; } catch (err) { console.error("Errore PDF:", err); alert("Errore creazione PDF."); playSound('error'); if (downloadPdfBtn) downloadPdfBtn.disabled = false; } }
            function getHeroStatusText(choice) { if (choice === true) return "Eroi Schierati"; if (choice === false) return "Nessun Eroe"; return "In attesa..."; }
            function populateSummary() { console.log("Popolo Riepilogo..."); const updateSummaryPlayer = (pNum, pState) => { const sumP=document.getElementById(`summary-p${pNum}`); if(!sumP) return; const nameEl=document.getElementById(`summary-p${pNum}-name`), heroEl=document.getElementById(`summary-p${pNum}-hero`), listEl=document.getElementById(`summary-p${pNum}-nations`), logoEl=sumP.querySelector(`.summary-alliance-logo`), alliNameEl=document.getElementById(`summary-p${pNum}-alliance-name`); if(!pState||!pState.name){ if(nameEl) nameEl.textContent='(N/D)'; if(heroEl){ heroEl.textContent='N/D'; heroEl.className='hero-decision'; } if(listEl) listEl.innerHTML='<li>-</li>'; if(logoEl) logoEl.style.display='none'; if(alliNameEl) alliNameEl.textContent='N/D'; return; } if(nameEl) nameEl.textContent=pState.name; const hTxt=getHeroStatusText(pState.heroChoice); if(heroEl){ heroEl.textContent=hTxt; heroEl.className=`hero-decision ${pState.heroChoice===true?'yes':(pState.heroChoice===false?'no':'')}`; } if(listEl){ listEl.innerHTML=''; const team=pState.team||[]; if(team.length>0){ team.forEach(id=>{ const nation=allNations.find(n=>n.id===id); const li=document.createElement('li'); if(nation){ li.innerHTML = `<img class="team-flag" src="https://flagcdn.com/w40/${nation.code}.png" alt="${nation.name}" loading="lazy" style="margin-right: 7px; vertical-align: middle;"><span>${nation.name}</span>`; } else { li.textContent=`ID:${id}`; } listEl.appendChild(li); }); } else { listEl.innerHTML='<li>- Nessuna nazione -</li>'; } } const aId=pState.allianceId; const alli=aId?getAllianceById(aId):null; if(alli&&logoEl){ logoEl.src=alli.logo_path||""; logoEl.alt=alli.name?`Logo ${alli.name}`:"Logo"; logoEl.style.display=alli.logo_path?'inline-block':'none'; if(alliNameEl) alliNameEl.textContent=alli.name; } else { if(logoEl){ logoEl.style.display='none'; logoEl.src=""; } if(alliNameEl) alliNameEl.textContent=aId?'ID:'+aId:'N/D'; } }; updateSummaryPlayer(1, localGameState.player1); updateSummaryPlayer(2, localGameState.player2); }
            function renderTeams() { const renderList = (teamEl, teamData, countEl) => { if (!teamEl || !countEl) return; teamEl.innerHTML = ''; const currentTeam = teamData || []; countEl.textContent = currentTeam.length; if (currentTeam.length > 0) { currentTeam.forEach(nationId => { const nation = allNations.find(n => n.id === nationId); if (nation) { const nationEl = document.createElement('span'); nationEl.className = 'team-nation'; nationEl.title = `${nation.name}`; nationEl.innerHTML = `<img class="team-flag" src="https://flagcdn.com/w40/${nation.code}.png" alt="${nation.name}" loading="lazy"><span style="margin-left: 5px;">${nation.name}</span>`; teamEl.appendChild(nationEl); } }); } }; if(p1TeamEl && p1CountEl) renderList(p1TeamEl, localGameState.player1?.team, p1CountEl); if(p2TeamEl && p2CountEl) renderList(p2TeamEl, localGameState.player2?.team, p2CountEl); }
            function renderNations() { if(!nationsListEl) return; nationsListEl.innerHTML = ''; if (!localGameState || localGameState.gamePhase !== 'draft') { return; } const p1Team = localGameState.player1?.team || []; const p2Team = localGameState.player2?.team || []; const selectedIds = new Set([...p1Team, ...p2Team]); const canSelect = localGameState.currentPlayer === playerRole && (localGameState[`player${playerRole}`]?.team?.length || 0) < 5; allNations.forEach(nation => { const isSelected = selectedIds.has(nation.id); const nationCard = document.createElement('div'); nationCard.className = 'nation-card'; nationCard.dataset.nationId = nation.id; const tooltipHtml = `<div class="nation-tooltip"><strong>${nation.name}</strong><br>Bonus: ${nation.bonus || 'N/D'}<br><i>${nation.description || ''}</i></div>`; nationCard.innerHTML = `<img class="flag" src="https://flagcdn.com/w80/${nation.code}.png" alt="${nation.name}" title="${nation.name}" loading="lazy"><div class="name">${nation.name}</div>${tooltipHtml}`; nationCard.onclick = null; nationCard.onmouseover = null; nationCard.onmouseout = null; const tooltipElement = nationCard.querySelector('.nation-tooltip'); if (isSelected) { nationCard.classList.add('disabled'); } else { nationCard.onmouseover = () => { if (tooltipElement) tooltipElement.style.display = 'block'; }; nationCard.onmouseout = () => { if (tooltipElement) tooltipElement.style.display = 'none'; }; if (canSelect) { nationCard.classList.add('available'); nationCard.onclick = () => selectNationWithAnimation(nationCard, nation); } else { nationCard.classList.add('disabled'); nationCard.style.cursor = 'not-allowed'; } } nationsListEl.appendChild(nationCard); }); }
            function updateGamePhaseDisplay() { if(!gamePhaseEl) return; const phase = localGameState.gamePhase; let mainTextContent = "Attendere..."; const statusP1Node = document.getElementById('hero-status-p1'); const statusP2Node = document.getElementById('hero-status-p2'); gamePhaseEl.innerHTML = ''; gamePhaseEl.style.backgroundColor = 'rgba(210, 190, 160, 0.95)'; gamePhaseEl.style.color = 'var(--color-text-dark)'; let currentStatusP1, currentStatusP2; if (statusP1Node) { currentStatusP1 = statusP1Node.cloneNode(true); currentStatusP1.style.display = 'none'; currentStatusP1.textContent = ''; gamePhaseEl.appendChild(currentStatusP1); } if (statusP2Node) { currentStatusP2 = statusP2Node.cloneNode(true); currentStatusP2.style.display = 'none'; currentStatusP2.textContent = ''; gamePhaseEl.appendChild(currentStatusP2); } switch (phase) { case "waiting": const wp1=localGameState.player1?.name; const wp2=localGameState.player2?.name; if(wp1&&!wp2){mainTextContent = `Attendere Generale 2... <br><small style='font-family:var(--font-serif); text-transform:none; font-weight:normal;'>Inviare link stanza!</small>`;} else if(!wp1&&wp2){mainTextContent=`Attendere Generale 1...`;} else if(!wp1&&!wp2){mainTextContent=`Attendere Generali...`;} else {mainTextContent="Quartier Generale pronto...";} break; case "draft": const dp1=localGameState.player1?.name||'?'; const dp2=localGameState.player2?.name||'?'; const dTurn=localGameState.currentPlayer; const dCurrName=dTurn===1?dp1:dp2; if(!dTurn){mainTextContent="Attendere..."; break;} if(dTurn===playerRole){mainTextContent=`<span style="color: var(--color-accent-dark); font-weight: bold;">Generale ${dTurn}, Vostro Turno!</span><br><small style='font-family:var(--font-serif); text-transform:none; font-weight:normal;'>Selezionare nazione.</small>`;} else {mainTextContent=`Attendere Generale ${dTurn} (${dCurrName})...`;} break; case "completed": mainTextContent="Selezione completata. Preparo fase Eroi..."; break; case "hero_selection": mainTextContent="Decisione Schieramento Eroi"; if(currentStatusP1){ currentStatusP1.textContent=`Generale 1 (${localGameState.player1?.name||'?'}): ${getHeroStatusText(localGameState.player1?.heroChoice)}`; currentStatusP1.style.display='block'; } if(currentStatusP2){ currentStatusP2.textContent=`Generale 2 (${localGameState.player2?.name||'?'}): ${getHeroStatusText(localGameState.player2?.heroChoice)}`; currentStatusP2.style.display='block'; } break; case "summary": mainTextContent="Riepilogo Finale Selezione"; gamePhaseEl.style.backgroundColor='rgba(180, 210, 180, 0.95)'; break; default: mainTextContent=`Stato Sconosciuto: ${phase}`; gamePhaseEl.style.backgroundColor='rgba(255, 200, 200, 0.9)'; console.error("Fase gioco sconosciuta:", phase); } gamePhaseEl.insertAdjacentHTML('afterbegin', `<span class="main-phase-text">${mainTextContent}</span>`); }
            function handleGameEndCleanup() { const logPrefix = `[${playerName || 'N/A'} - P${playerRole || '?'}]`; console.log(`${logPrefix} Cleanup...`); if (roomRef) { roomRef.off("value"); roomRef = null; } clearInterval(timerInterval); timerInterval = null; localGameState = {}; playerRole = null; const oldRoomId = roomId; roomId = ""; playerName = ""; if(gameContainer) gameContainer.style.opacity = '0'; setTimeout(() => { if(gameContainer) gameContainer.style.display = 'none'; if(loginContainer) loginContainer.style.display = 'block'; resetLoginUI(); if(displayRoomId) displayRoomId.textContent = ''; if(displayPlayerName) displayPlayerName.textContent = ''; if(displayPlayerRole) displayPlayerRole.textContent = ''; if(p1TeamEl) p1TeamEl.innerHTML = ''; if(p2TeamEl) p2TeamEl.innerHTML = ''; if(p1CountEl) p1CountEl.textContent = '0'; if(p2CountEl) p2CountEl.textContent = '0'; if(nationsListEl) nationsListEl.innerHTML = ''; if(gamePhaseEl) gamePhaseEl.innerHTML = '<span class="main-phase-text">Attendere...</span><div class="hero-status" id="hero-status-p1" style="display: none;"></div><div class="hero-status" id="hero-status-p2" style="display: none;"></div>'; if(timerEl) timerEl.textContent = ''; if(timerBarContainer) timerBarContainer.style.display = 'none'; if(timerBar) timerBar.style.width = '100%'; if(heroSelectionSection) heroSelectionSection.style.display = 'none'; if(summarySection) summarySection.style.display = 'none'; if (downloadPdfBtn) downloadPdfBtn.style.display = 'none'; if (resetBtn) resetBtn.style.display = 'inline-block'; if (thankYouModal && thankYouModal.classList.contains('visible')) { thankYouModal.classList.remove('visible'); thankYouModal.style.display = 'none'; } console.log(`${logPrefix} Cleanup completato per ${oldRoomId}.`); }, 300); if (window.history.replaceState) { const cleanUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`; try { window.history.replaceState({ path: cleanUrl }, '', cleanUrl); } catch (e) { console.warn("Impossibile pulire URL:", e); } } }
            function handleCopyClick() { playSound('click'); if (!roomId) { alert("No room."); playSound('error'); return; } const cleanUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`; const inviteUrl = `${cleanUrl}?room=${roomId}`; navigator.clipboard.writeText(inviteUrl).then(() => { const icon = copyBtn.innerHTML; copyBtn.innerHTML = '<i class="fa-solid fa-check" style="color: green;"></i>'; setTimeout(() => { if(copyBtn) copyBtn.innerHTML = icon; }, 1500); playSound('complete'); }, (err) => { console.error('Errore copia:', err); prompt("Copia manuale:", inviteUrl); playSound('error'); }); }
            function handleResetClick() { playSound('click'); if (!roomId || !playerRole || !isAuthComplete) return; if (confirm("Confermi ritirata?")) { playSound('heroYes'); if (roomRef) { roomRef.off("value"); roomRef = null; } if (!database) { handleGameEndCleanup(); return; } const user = auth.currentUser; if (!user) { console.error("No user per ritirata!"); handleGameEndCleanup(); return;} const playerUidPath = `/rooms/${roomId}/player${playerRole}/uid`; database.ref(playerUidPath).once('value').then(uidSnapshot => { if (uidSnapshot.exists() && uidSnapshot.val() !== user.uid) { console.warn(`Ritirata fallita: UID mismatch.`); alert("Errore identità."); if (roomId && !roomRef) listenToRoomChanges(); return; } const playerPath = `/rooms/${roomId}/player${playerRole}`; database.ref(playerPath).remove().then(() => { console.log(`P${playerRole} rimosso.`); database.ref(`/rooms/${roomId}`).once('value').then(snapshot => { const d=snapshot.val(); if (!d || (!d.player1?.name && !d.player2?.name)) { console.log(`Stanza ${roomId} vuota, elimino...`); database.ref(`/rooms/${roomId}`).remove().catch(err=>console.error("Err elim stanza:", err)); } }); handleGameEndCleanup(); }).catch(error => { console.error("Errore rimozione:", error); alert("Errore ritirata: " + error.message); handleGameEndCleanup(); }); }).catch(err => { console.error("Errore verifica UID ritirata:", err); alert("Errore verifica ritirata."); if (roomId && !roomRef) listenToRoomChanges(); }); } else { playSound('heroNo'); } }
            function handleModalClose() { playSound('click'); if (thankYouModal) { thankYouModal.classList.remove('visible'); setTimeout(() => { thankYouModal.style.display = 'none'; }, 300); } }
            function handleModalOverlayClick(event) { if (thankYouModal && event.target === thankYouModal) { if(modalCloseBtn) modalCloseBtn.click(); } }
            function handleDownloadPdfClick() { playSound('click'); if(downloadPdfBtn) downloadPdfBtn.disabled = true; generateAndDownloadPDF(); }

            // --- Funzione Setup Applicazione ---
            function setupApplication() {
                console.log("Setup Applicazione (post-auth).");
                try { const urlParams = new URLSearchParams(window.location.search); const roomParam = urlParams.get('room'); if (roomParam && roomIdInput) { const sanitizedRoomId = roomParam.trim().toUpperCase().substring(0, 8); if (/^[A-Z0-9]+$/.test(sanitizedRoomId) && sanitizedRoomId.length > 0) { roomIdInput.value = sanitizedRoomId; console.log(`ID Stanza precompilato: ${sanitizedRoomId}`); } else { console.warn(`ID Stanza URL non valido: "${roomParam}"`); if (window.history.replaceState) { const cleanUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`; try { window.history.replaceState({ path: cleanUrl }, '', cleanUrl); } catch (e) {} } } } } catch (e) { console.error("Errore parametri URL:", e); }
                if (allianceSelect) { allianceSelect.innerHTML = '<option value="" disabled selected>-- Seleziona Alleanza --</option>'; loadedAlliances.sort((a, b) => a.name.localeCompare(b.name)).forEach(alliance => { const option = document.createElement('option'); option.value = alliance.id; option.textContent = alliance.name; allianceSelect.appendChild(option); }); allianceSelect.disabled = false; console.log("Select Alleanza popolato."); } else { console.error("Select non trovato!"); }
                const checkLoginInputs = () => { if (!playerNameInput || !allianceSelect || !joinBtn) return; const nameFilled = playerNameInput.value.trim().length > 0; const allianceSelected = allianceSelect.value !== ""; joinBtn.disabled = !(nameFilled && allianceSelected && isAuthComplete); };
                if (playerNameInput) playerNameInput.addEventListener('input', checkLoginInputs); if (allianceSelect) allianceSelect.addEventListener('change', checkLoginInputs); checkLoginInputs();
                initializeAudio();
                if (joinBtn && !joinBtn.dataset.listenerAttached) { joinBtn.addEventListener('click', handleJoinClick); joinBtn.dataset.listenerAttached = 'true'; }
                if (copyBtn && !copyBtn.dataset.listenerAttached) { copyBtn.addEventListener('click', handleCopyClick); copyBtn.dataset.listenerAttached = 'true'; }
                if (resetBtn && !resetBtn.dataset.listenerAttached) { resetBtn.addEventListener('click', handleResetClick); resetBtn.dataset.listenerAttached = 'true'; }
                if (heroYesBtn && !heroYesBtn.dataset.listenerAttached) { heroYesBtn.addEventListener('click', () => handleHeroChoice(true)); heroYesBtn.dataset.listenerAttached = 'true'; }
                if (heroNoBtn && !heroNoBtn.dataset.listenerAttached) { heroNoBtn.addEventListener('click', () => handleHeroChoice(false)); heroNoBtn.dataset.listenerAttached = 'true'; }
                if (modalCloseBtn && !modalCloseBtn.dataset.listenerAttached) { modalCloseBtn.addEventListener('click', handleModalClose); modalCloseBtn.dataset.listenerAttached = 'true'; }
                if (thankYouModal && !thankYouModal.dataset.listenerAttached) { thankYouModal.addEventListener('click', handleModalOverlayClick); thankYouModal.dataset.listenerAttached = 'true'; }
                if (downloadPdfBtn && !downloadPdfBtn.dataset.listenerAttached) { downloadPdfBtn.addEventListener('click', handleDownloadPdfClick); downloadPdfBtn.dataset.listenerAttached = 'true'; }
                if(gameContainer) { gameContainer.style.display = 'none'; gameContainer.style.opacity = '0'; } console.log("Setup App completato.");
            }
            // L'esecuzione di setupApplication() è legata al .then() dell'autenticazione.

        }); // Fine DOMContentLoaded

    </script>

</body>
</html>
