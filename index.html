        // --- CONFIGURAZIONE FIREBASE REALE ---
        const firebaseConfig = { apiKey: "AIzaSyBMSMS7TCBVATqdoCqNX99AriyiSpy9y8E", authDomain: "supremacy-web.firebaseapp.com", databaseURL: "https://supremacy-web-default-rtdb.europe-west1.firebasedatabase.app", projectId: "supremacy-web", storageBucket: "supremacy-web.firebasestorage.app", messagingSenderId: "30781020744", appId: "1:30781020744:web:81eee78242a060a9d6167d", measurementId: "G-VTMYEXEDSW" };
        let database;
        try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); console.log("Firebase inizializzato."); } else { firebase.app(); console.log("Firebase già inizializzato."); } database = firebase.database(); } catch (e) { console.error("ERRORE INIT FIREBASE:", e); alert("Errore Inizializzazione Firebase."); document.body.innerHTML = '<h1 style="color:red; text-align:center;">Errore Critico: Inizializzazione Firebase fallita.</h1>'; }
        const { jsPDF } = window.jspdf;
        const allNations = [ { id: 1, name: "Marocco", code: "ma", bonus: "Posizione strategica", description: "Crocevia tra Africa ed Europa" }, { id: 2, name: "Spagna", code: "es", bonus: "Esplorazione +10%", description: "Terra di conquistadores" }, { id: 3, name: "Francia", code: "fr", bonus: "Diplomazia +15%", description: "Terra di rivoluzioni e vino" }, { id: 4, name: "Gran Bretagna", code: "gb", bonus: "Commercio +15%", description: "Impero marittimo storico" }, { id: 5, name: "Germania", code: "de", bonus: "Produzione +20%", description: "Potenza industriale europea" }, { id: 6, name: "Italia", code: "it", bonus: "Cultura +10%", description: "Patria dell'arte e della cucina" }, { id: 7, name: "Austria", code: "at", bonus: "Musica +10%", description: "Cuore dell'Europa centrale" }, { id: 8, name: "Turchia", code: "tr", bonus: "Posizione +15%", description: "Crocevia tra continenti" }, { id: 9, name: "Russia", code: "ru", bonus: "Territorio +25%", description: "Vasta nazione euroasiatica" }, { id: 10, name: "Svezia", code: "se", bonus: "Innovazione +10%", description: "Terra di tecnologia e natura" } ];
        let localGameState = {}; let playerRole = null; let playerName = ""; let roomId = ""; let timerInterval = null; let roomRef = null;
        let turnStartTime = 0; let timerDuration = 3600000;

        // --- Elementi DOM ---
        const loginContainer = document.getElementById('login-container'); const gameContainer = document.getElementById('game-container'); const playerNameInput = document.getElementById('player-name'); const roomIdInput = document.getElementById('room-id'); const joinBtn = document.getElementById('join-btn'); const displayRoomId = document.getElementById('display-room-id'); const displayPlayerName = document.getElementById('display-player-name'); const displayPlayerRole = document.getElementById('display-player-role'); const nationsListEl = document.getElementById('nations-list'); const p1TeamEl = document.getElementById('p1-team'); const p2TeamEl = document.getElementById('p2-team'); const p1CountEl = document.getElementById('p1-count'); const p2CountEl = document.getElementById('p2-count'); const gamePhaseEl = document.getElementById('game-phase'); const timerEl = document.getElementById('timer'); const player1El = document.getElementById('player1'); const player2El = document.getElementById('player2'); const resetBtn = document.getElementById('reset-btn'); const copyBtn = document.getElementById('copy-btn');
        const nationsContainer = document.getElementById('nations-container');
        const heroSelectionSection = document.getElementById('hero-selection-section');
        const heroChoiceButtons = document.getElementById('hero-choice-buttons');
        const heroYesBtn = document.getElementById('hero-yes-btn');
        const heroNoBtn = document.getElementById('hero-no-btn');
        const heroWaitMessage = document.getElementById('hero-wait-message');
        const summarySection = document.getElementById('summary-section');
        const heroStatusP1 = document.getElementById('hero-status-p1');
        const heroStatusP2 = document.getElementById('hero-status-p2');
        const timerBarContainer = document.getElementById('timer-bar-container');
        const timerBar = document.getElementById('timer-bar');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const thankYouModal = document.getElementById('thank-you-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Definizione Oggetti Audio (Percorsi relativi verificati) ---
        let sounds = {}; // Inizializza vuoto, verrà popolato dopo check supporto
        const soundFiles = {
            click: 'sounds/click.mp3',
            turn: 'sounds/turn.mp3',
            heroYes: 'sounds/hero_yes.mp3',
            heroNo: 'sounds/hero_no.mp3',
            error: 'sounds/error.mp3',
            complete: 'sounds/complete.mp3'
        };

        // Funzione per caricare e preparare i suoni
        function initializeAudio() {
            console.log("Inizializzazione Audio...");
            for (const key in soundFiles) {
                try {
                    const audio = new Audio(soundFiles[key]);
                    audio.preload = 'auto'; // Tenta il precaricamento
                    audio.load(); // Forza il caricamento iniziale dei metadati
                    audio.volume = 0.6; // Imposta volume
                    sounds[key] = audio;
                    console.log(`Audio '${key}' caricato da ${soundFiles[key]}`);
                } catch (e) {
                    console.error(`Errore durante la creazione dell'oggetto Audio per ${key}:`, e);
                    // Lascia sounds[key] undefined se c'è un errore
                }
            }
            // Aggiungi un listener per il primo gesto utente per sbloccare l'audio
            // Usiamo 'pointerup' che funziona sia per mouse che per touch
             document.body.addEventListener('pointerup', unlockAudioContext, { once: true });
             console.log("Listener per sblocco audio aggiunto a 'pointerup' sul body.");
        }

        // Funzione per sbloccare il contesto audio (chiamata una sola volta)
        let audioUnlocked = false;
        function unlockAudioContext() {
            if (audioUnlocked) return;
            console.log("Tentativo di sblocco Contesto Audio...");
            // Tentativo di riprodurre e mettere in pausa un suono silenzioso o il primo suono
            const soundToUnlock = sounds['click'] || Object.values(sounds)[0]; // Prendi il primo suono disponibile
            if (soundToUnlock) {
                 // Usa un timeout brevissimo per assicurare che sia nel contesto dell'evento utente
                setTimeout(() => {
                    const playPromise = soundToUnlock.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            soundToUnlock.pause();
                            soundToUnlock.currentTime = 0;
                            audioUnlocked = true;
                            console.log("Contesto Audio sbloccato con successo.");
                        }).catch(error => {
                            console.warn("Sblocco Contesto Audio fallito (potrebbe essere già sbloccato o browser restrittivo):", error);
                            // Considera audioUnlocked = true anche qui? Dipende dal browser.
                            // A volte il solo tentativo è sufficiente. Per sicurezza, lo impostiamo.
                            audioUnlocked = true;
                        });
                    } else {
                        // Alcuni browser non restituiscono una promise se l'autoplay è bloccato severamente
                        console.warn("sound.play() non ha restituito una promise, autoplay policy severa?");
                         audioUnlocked = true; // Assumiamo sia sbloccato anche se non possiamo verificarlo
                    }
                }, 0);
            } else {
                console.warn("Nessun suono disponibile per tentare lo sblocco audio.");
                 audioUnlocked = true; // Non c'è nulla da sbloccare
            }
             // Rimuovi il listener per sicurezza (anche se c'è {once: true})
             document.body.removeEventListener('pointerup', unlockAudioContext);

        }


        // Funzione per riprodurre suoni (leggermente modificata)
        function playSound(soundName) {
             // Non provare a riprodurre se l'audio non è stato sbloccato
             // (anche se il tentativo potrebbe essere già avvenuto)
            // if (!audioUnlocked) {
            //     console.log(`Riproduzione suono '${soundName}' saltata: audio non ancora sbloccato.`);
            //     return;
            // }

            const sound = sounds[soundName];
            if (sound) {
                console.log(`Riproduzione suono: ${soundName}`); // Log riproduzione
                sound.currentTime = 0; // Sempre riavvolgi
                sound.play().catch(e => console.warn(`Errore durante play() per ${soundName}:`, e)); // Logga ancora errori specifici
            } else {
                console.warn(`Suono non trovato: ${soundName}`);
            }
        }
        // -------------------------------


        // --- Funzioni di Gioco ---
        function generateRoomId() { return Math.random().toString(36).substring(2, 6).toUpperCase(); }

        joinBtn.addEventListener('click', () => {
            // Ora playSound viene chiamato DOPO il tentativo di sblocco implicito o esplicito
             playSound('click'); // Prova a riprodurre il suono qui
             playerName = playerNameInput.value.trim(); let potentialRoomId = roomIdInput.value.trim().toUpperCase(); if (!playerName) { alert("Inserire nome in codice."); playSound('error'); return; } if (!database) { console.error("DB non disponibile."); alert("Errore Database."); playSound('error'); return; } joinBtn.disabled = true; if (!potentialRoomId) { roomId = generateRoomId(); playerRole = 1; initializeGame(); } else { roomId = potentialRoomId; joinRoom(); } });
        // ... (Resto delle funzioni: joinRoom, resetLoginUI, initializeGameView, initializeGame - invariate) ...
        function joinRoom() { console.log("Funzione joinRoom"); if (!database) { console.error("DB Error"); joinBtn.disabled = false; return; } const currentRoomRef = database.ref(`rooms/${roomId}`); currentRoomRef.once('value').then(snapshot => { if (snapshot.exists()) { const roomData = snapshot.val() || {}; const p1Data = roomData.player1 || {}; const p2Data = roomData.player2 || {}; const p1Exists = !!p1Data.name; const p2Exists = !!p2Data.name; if (p1Exists && p1Data.name === playerName) { console.log("Riconnesso G1"); alert("Riconnesso come Comando 1."); playSound('turn'); playerRole = 1; initializeGameView(); listenToRoomChanges(); return; } if (p2Exists && p2Data.name === playerName) { console.log("Riconnesso G2"); alert("Riconnesso come Comando 2."); playSound('turn'); playerRole = 2; initializeGameView(); listenToRoomChanges(); return; } if (p1Exists && p2Exists) { console.warn("Stanza piena"); alert("Stanza strategica piena!"); playSound('error'); resetLoginUI(); return; } playerRole = p1Exists ? 2 : 1; console.log("Assegnato ruolo:", playerRole); initializeGame(); } else { console.warn("Stanza non trovata:", roomId); alert("Stanza non trovata!"); playSound('error'); resetLoginUI(); } }).catch(error => { console.error("Errore lettura DB (joinRoom):", error); alert("Errore connessione stanza: " + error.message); playSound('error'); resetLoginUI(); }); }
        function resetLoginUI() { console.log("Reset UI Login."); roomId = ""; if(roomRef) { roomRef.off("value"); roomRef = null;} playerRole = null; joinBtn.disabled = false; roomIdInput.value = ''; loginContainer.style.display = 'block'; gameContainer.style.display = 'none'; }
        function initializeGameView() { loginContainer.style.display = 'none'; gameContainer.style.display = 'block'; displayRoomId.textContent = roomId; displayPlayerName.textContent = playerName; displayPlayerRole.textContent = `Comando ${playerRole}`; }
        function initializeGame() { console.log("Funzione initializeGame (scrittura dati)"); if (!database) { console.error("DB Error"); resetLoginUI(); return; } initializeGameView(); const updates = {}; updates[`/rooms/${roomId}/player${playerRole}/name`] = playerName; updates[`/rooms/${roomId}/player${playerRole}/team`] = []; updates[`/rooms/${roomId}/player${playerRole}/heroChoice`] = null; const roomBaseRef = database.ref(`/rooms/${roomId}`); roomBaseRef.once('value').then(snapshot => { const roomData = snapshot.val() || {}; if (playerRole === 1 && !roomData.gamePhase) { console.log("G1 inizializza stato partita."); updates[`/rooms/${roomId}/currentPlayer`] = 1; updates[`/rooms/${roomId}/gamePhase`] = "waiting"; updates[`/rooms/${roomId}/timerEnd`] = null; updates[`/rooms/${roomId}/player1/heroChoice`] = null; updates[`/rooms/${roomId}/player2/heroChoice`] = null; } console.log("Invio updates:", updates); database.ref().update(updates).then(() => { console.log("DB aggiornato. Avvio listener."); listenToRoomChanges(); }).catch(error => { console.error("Errore Update DB (initializeGame):", error); alert("Errore creazione/aggiornamento stanza: " + error.message); playSound('error'); handleGameEndCleanup(); }); }).catch(error => { console.error("Errore Read DB (initializeGame):", error); alert("Errore verifica stato stanza: " + error.message); playSound('error'); handleGameEndCleanup(); }); }

        function listenToRoomChanges() {
            console.log("Avvio listener stanza:", roomId);
            if (!database) { console.error("DB Error"); return; }
            if (roomRef) { roomRef.off("value"); }

            roomRef = database.ref(`rooms/${roomId}`);
            roomRef.on('value', snapshot => {
                if (!snapshot.exists()) { console.warn("Listener: Stanza cancellata."); if (document.getElementById('game-container').style.display !== 'none') { alert("La conferenza strategica è terminata."); playSound('error'); handleGameEndCleanup(); } return; }
                const roomData = snapshot.val(); if (!roomData || typeof roomData !== 'object') { return; }

                const prevPlayer = localGameState.currentPlayer; const prevPhase = localGameState.gamePhase;
                const p1Data = roomData.player1 || { name: "", team: [], heroChoice: null }; const p2Data = roomData.player2 || { name: "", team: [], heroChoice: null };
                const normalizeTeam = (team) => (!team ? [] : (Array.isArray(team) ? team : Object.values(team)));
                localGameState = { player1: { name: p1Data.name || "", team: normalizeTeam(p1Data.team), heroChoice: p1Data.heroChoice }, player2: { name: p2Data.name || "", team: normalizeTeam(p2Data.team), heroChoice: p2Data.heroChoice }, currentPlayer: roomData.currentPlayer !== undefined ? roomData.currentPlayer : null, gamePhase: roomData.gamePhase || "waiting", timerEnd: roomData.timerEnd || null };

                updateUI();

                 if(localGameState.gamePhase === 'draft' && localGameState.currentPlayer !== prevPlayer && localGameState.currentPlayer !== null) { if(localGameState.currentPlayer === playerRole) playSound('turn'); const el = document.getElementById(`player${localGameState.currentPlayer}`); if(el) { el.classList.remove('turn-pulse'); void el.offsetWidth; el.classList.add('turn-pulse'); setTimeout(() => el.classList.remove('turn-pulse'), 600); }}
                 // Riproduci suono "complete" quando SI ENTRA in queste fasi, venendo dalla fase precedente corretta
                 if ((localGameState.gamePhase === 'hero_selection' && prevPhase === 'draft') || (localGameState.gamePhase === 'summary' && prevPhase === 'hero_selection')) { playSound('complete'); }

                if (playerRole === 1) {
                    if (localGameState.gamePhase === "waiting" && prevPhase === "waiting" && localGameState.player1.name && localGameState.player2.name) { startDraft(); }
                }

                if (localGameState.gamePhase === "draft" && localGameState.timerEnd) { timerBarContainer.style.display = 'block'; startTimer(); } else { clearInterval(timerInterval); timerInterval = null; timerBarContainer.style.display = 'none'; }
            }, errorObject => { alert("Errore connessione persistente: " + errorObject.message); playSound('error'); handleGameEndCleanup(); });
        }

        function startDraft() { if (!database || !roomId || localGameState.gamePhase !== 'waiting') { return; } turnStartTime = Date.now(); timerDuration = 3600000; const startTime = turnStartTime + timerDuration; const updates = { gamePhase: "draft", currentPlayer: 1, timerEnd: startTime }; database.ref(`rooms/${roomId}`).update(updates).catch(error => { alert("Errore avvio draft: " + error.message); playSound('error'); }); }
        function startTimer() { clearInterval(timerInterval); timerInterval = null; if (!localGameState.timerEnd || localGameState.gamePhase !== 'draft') { timerEl.textContent = ''; timerBarContainer.style.display = 'none'; return; } turnStartTime = localGameState.timerEnd - timerDuration; const updateTimerDisplay = () => { const now = Date.now(); const endTime = localGameState.timerEnd; const remaining = endTime - now; if (remaining <= 0) { timerEl.textContent = "Tempo Scaduto!"; timerBar.style.width = '0%'; clearInterval(timerInterval); timerInterval = null; if (localGameState.currentPlayer === playerRole && localGameState.gamePhase === 'draft') { playSound('error'); skipTurn(); } } else { const h = Math.floor(remaining / 3600000); const m = Math.floor((remaining % 3600000) / 60000); const s = Math.floor((remaining % 60000) / 1000); timerEl.textContent = `Tempo: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; const elapsed = now - turnStartTime; let p = 100 - (elapsed / timerDuration * 100); p=Math.max(0,Math.min(100,p)); timerBar.style.width = `${p}%`; } }; updateTimerDisplay(); timerInterval = setInterval(updateTimerDisplay, 1000); }
        function skipTurn() { if (!database || !roomId || localGameState.gamePhase !== 'draft' || localGameState.currentPlayer !== playerRole) { return; } const nextPlayer = localGameState.currentPlayer === 1 ? 2 : 1; turnStartTime = Date.now(); timerDuration = 3600000; const newTimerEnd = turnStartTime + timerDuration; database.ref(`rooms/${roomId}`).update({ currentPlayer: nextPlayer, timerEnd: newTimerEnd }).catch(error => console.error("Errore Update DB (skipTurn):", error)); }
        function selectNationWithAnimation(cardElement, nation) { playSound('click'); cardElement.classList.remove('available'); cardElement.classList.add('selecting'); cardElement.onclick = null; cardElement.onmouseover = null; cardElement.onmouseout = null; const tooltip = cardElement.querySelector('.nation-tooltip'); if(tooltip) tooltip.style.display = 'none'; setTimeout(() => { selectNation(nation); }, 150); }
        function selectNation(nation) { if (!database || !roomId || !nation || typeof nation.id === 'undefined') { return; } if (localGameState.gamePhase !== "draft") { alert("La selezione non è attiva."); playSound('error'); return; } if (localGameState.currentPlayer !== playerRole) { alert("Attendere il proprio turno."); playSound('error'); return; } const playerTeam = localGameState[`player${playerRole}`]?.team || []; if (playerTeam.length >= 5) { alert("Limite nazioni raggiunto."); playSound('error'); return; } const p1Team = localGameState.player1?.team || []; const p2Team = localGameState.player2?.team || []; if (p1Team.includes(nation.id) || p2Team.includes(nation.id)) { alert(`${nation.name} già selezionata.`); playSound('error'); return; } const teamKey = `player${playerRole}/team`; const newTeam = [...playerTeam, nation.id]; const nextPlayer = playerRole === 1 ? 2 : 1; turnStartTime = Date.now(); timerDuration = 3600000; const newTimerEnd = turnStartTime + timerDuration; let newPhase = "draft"; let newCurrentPlayer = nextPlayer; const p1Count = (playerRole === 1) ? newTeam.length : p1Team.length; const p2Count = (playerRole === 2) ? newTeam.length : p2Team.length; const updates = {}; updates[`/rooms/${roomId}/${teamKey}`] = newTeam; if (p1Count === 5 && p2Count === 5) { newPhase = "hero_selection"; newCurrentPlayer = null; updates[`/rooms/${roomId}/timerEnd`] = null; } else { updates[`/rooms/${roomId}/timerEnd`] = newTimerEnd; } updates[`/rooms/${roomId}/currentPlayer`] = newCurrentPlayer; updates[`/rooms/${roomId}/gamePhase`] = newPhase; database.ref().update(updates).catch(error => { alert("Errore selezione nazione: " + error.message); playSound('error'); }); }

        function handleHeroChoice(choice) {
            // Suono spostato all'inizio del listener per coerenza
            if (!database || !roomId || playerRole === null) { console.error("handleHeroChoice: Stato invalido."); playSound('error'); return; }
            if (localGameState.gamePhase !== 'hero_selection') { console.warn(`handleHeroChoice: Fase errata (${localGameState.gamePhase}).`); return; } // Non suonare se non è la fase giusta
            if (localGameState[`player${playerRole}`]?.heroChoice !== null) { console.warn("handleHeroChoice: Scelta già fatta."); return; } // Non suonare se già scelto

            playSound(choice ? 'heroYes' : 'heroNo'); // Suona DOPO i controlli
            heroYesBtn.disabled = true; heroNoBtn.disabled = true; heroWaitMessage.style.display = 'block';

            const myChoicePath = `/rooms/${roomId}/player${playerRole}/heroChoice`;
            const opponentRole = playerRole === 1 ? 2 : 1;
            const opponentChoicePath = `/rooms/${roomId}/player${opponentRole}/heroChoice`;
            const updates = {}; updates[myChoicePath] = choice;

            database.ref(opponentChoicePath).once('value').then(snapshot => {
                 const opponentChoiceValue = snapshot.val(); const opponentHasChosen = opponentChoiceValue !== null;
                 if (opponentHasChosen) { updates[`/rooms/${roomId}/gamePhase`] = "summary"; updates[`/rooms/${roomId}/currentPlayer`] = null; updates[`/rooms/${roomId}/timerEnd`] = null; }
                 database.ref().update(updates).catch(error => { alert("Errore registrazione scelta."); playSound('error'); heroWaitMessage.style.display = 'none'; });
            }).catch(error => { alert("Errore verifica avversario."); playSound('error'); heroYesBtn.disabled = false; heroNoBtn.disabled = false; heroWaitMessage.style.display = 'none'; });
        }
        console.log("Aggiungo listener bottoni eroi...");
        heroYesBtn.addEventListener('click', () => { console.log("CLICK SI"); handleHeroChoice(true); });
        heroNoBtn.addEventListener('click', () => { console.log("CLICK NO"); handleHeroChoice(false); });

        function generateAndDownloadPDF() { console.log("Genero PDF..."); if (typeof jsPDF==='undefined') { alert("Errore PDF."); playSound('error'); return; } if (!localGameState?.player1?.team || !localGameState?.player2?.team || !roomId) { alert("Errore dati PDF."); playSound('error'); return; } try { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const getNationName = (id) => allNations.find(n => n.id === id)?.name || `ID ${id}`; const getHeroText = (c) => (c === true ? 'Si' : (c === false ? 'No' : 'N/D')); let y=15; const ls=7; const ss=12; const lm=15; const co=110; doc.setFontSize(18); doc.setFont(undefined,'bold'); doc.text("Riepilogo Selezione Supremacy 1914 ITA", doc.internal.pageSize.getWidth()/2, y, {align:'center'}); y+=ss; doc.setFontSize(10); doc.setFont(undefined,'normal'); doc.text(`Stanza: ${roomId}`, lm, y); const now=new Date(); doc.text(`Data: ${now.toLocaleDateString('it-IT')} ${now.toLocaleTimeString('it-IT')}`, co, y); y+=ss; doc.setLineWidth(.3); doc.line(lm, y-ss/2, doc.internal.pageSize.getWidth()-lm, y-ss/2); doc.setFontSize(14); doc.setFont(undefined,'bold'); doc.text(`Comando 1: ${localGameState.player1.name||'N/D'}`, lm, y); y+=ls*1.5; doc.setFontSize(11); doc.setFont(undefined,'bold'); doc.text("Nazioni:", lm, y); y+=ls; doc.setFont(undefined,'normal'); (localGameState.player1.team||[]).forEach((id,i)=>{ doc.text(`${i+1}. ${getNationName(id)}`, lm+5, y); y+=ls; }); if (!(localGameState.player1.team||[]).length){ doc.text("- Nessuna", lm+5, y); y+=ls; } y+=ls/2; doc.setFont(undefined,'bold'); doc.text(`Eroi: ${getHeroText(localGameState.player1.heroChoice)}`, lm, y); y+=ss*1.5; doc.setFontSize(14); doc.setFont(undefined,'bold'); doc.text(`Comando 2: ${localGameState.player2.name||'N/D'}`, lm, y); y+=ls*1.5; doc.setFontSize(11); doc.setFont(undefined,'bold'); doc.text("Nazioni:", lm, y); y+=ls; doc.setFont(undefined,'normal'); (localGameState.player2.team||[]).forEach((id,i)=>{ doc.text(`${i+1}. ${getNationName(id)}`, lm+5, y); y+=ls; }); if (!(localGameState.player2.team||[]).length){ doc.text("- Nessuna", lm+5, y); y+=ls; } y+=ls/2; doc.setFont(undefined,'bold'); doc.text(`Eroi: ${getHeroText(localGameState.player2.heroChoice)}`, lm, y); const fn=`Riepilogo_${roomId}.pdf`; doc.save(fn); console.log("PDF generato:", fn); playSound('complete'); if (thankYouModal) { thankYouModal.style.display='flex'; void thankYouModal.offsetWidth; thankYouModal.classList.add('visible'); } else { alert("Lo Staff Supremacy 1914..."); } if(downloadPdfBtn) downloadPdfBtn.style.display='none'; if(resetBtn) resetBtn.style.display='none'; } catch (err) { console.error("Errore generazione PDF:", err); alert("Errore creazione PDF."); playSound('error'); if(downloadPdfBtn) downloadPdfBtn.disabled=false; } }
        downloadPdfBtn.addEventListener('click', () => { playSound('click'); downloadPdfBtn.disabled = true; generateAndDownloadPDF(); });
        modalCloseBtn.addEventListener('click', () => { playSound('click'); if (thankYouModal) { thankYouModal.classList.remove('visible'); setTimeout(() => { thankYouModal.style.display = 'none'; }, 300); } });
        thankYouModal.addEventListener('click', (event) => { if (event.target === thankYouModal) { modalCloseBtn.click(); } });

        function getHeroStatusText(choice) { if (choice === true) return "Eroi Schierati"; if (choice === false) return "Nessun Eroe"; return "In attesa..."; }
        function populateSummary() { document.getElementById('summary-p1-name').textContent = localGameState.player1.name || 'N/D'; document.getElementById('summary-p2-name').textContent = localGameState.player2.name || 'N/D'; const heroTextP1 = getHeroStatusText(localGameState.player1.heroChoice); const heroP1El = document.getElementById('summary-p1-hero'); heroP1El.textContent = heroTextP1; heroP1El.className = `hero-decision ${localGameState.player1.heroChoice === true ? 'yes' : (localGameState.player1.heroChoice === false ? 'no' : '')}`; const heroTextP2 = getHeroStatusText(localGameState.player2.heroChoice); const heroP2El = document.getElementById('summary-p2-hero'); heroP2El.textContent = heroTextP2; heroP2El.className = `hero-decision ${localGameState.player2.heroChoice === true ? 'yes' : (localGameState.player2.heroChoice === false ? 'no' : '')}`; const listP1 = document.getElementById('summary-p1-nations'); listP1.innerHTML = ''; (localGameState.player1.team || []).forEach(id => { const nation = allNations.find(n => n.id === id); const li = document.createElement('li'); li.textContent = nation ? nation.name : `ID Sconosciuto: ${id}`; listP1.appendChild(li); }); const listP2 = document.getElementById('summary-p2-nations'); listP2.innerHTML = ''; (localGameState.player2.team || []).forEach(id => { const nation = allNations.find(n => n.id === id); const li = document.createElement('li'); li.textContent = nation ? nation.name : `ID Sconosciuto: ${id}`; listP2.appendChild(li); }); }
        function updateUI() { player1El.querySelector('h2').textContent = localGameState.player1?.name ? `Comando 1: ${localGameState.player1.name}` : "Comando 1 (Attendere)"; player2El.querySelector('h2').textContent = localGameState.player2?.name ? `Comando 2: ${localGameState.player2.name}` : "Comando 2 (Attendere)"; player1El.classList.toggle('active', localGameState.currentPlayer === 1 && localGameState.gamePhase === "draft"); player2El.classList.toggle('active', localGameState.currentPlayer === 2 && localGameState.gamePhase === "draft"); renderTeams(); updateGamePhaseDisplay(); renderNations(); const currentPhase = localGameState.gamePhase; nationsContainer.style.display = (currentPhase === 'draft') ? 'block' : 'none'; heroSelectionSection.style.display = (currentPhase === 'hero_selection') ? 'block' : 'none'; summarySection.style.display = (currentPhase === 'summary') ? 'block' : 'none'; if (currentPhase === 'hero_selection') { const myChoice = localGameState[`player${playerRole}`]?.heroChoice; const opponentRole = playerRole === 1 ? 2 : 1; const opponentChoice = localGameState[`player${opponentRole}`]?.heroChoice; const shouldBeDisabled = !(myChoice === null || typeof myChoice === 'undefined'); heroYesBtn.disabled = shouldBeDisabled; heroNoBtn.disabled = shouldBeDisabled; heroYesBtn.classList.toggle('selected', myChoice === true); heroNoBtn.classList.toggle('selected', myChoice === false); heroWaitMessage.style.display = (shouldBeDisabled && (opponentChoice === null || typeof opponentChoice === 'undefined')) ? 'block' : 'none'; heroChoiceButtons.style.display = 'block'; } else { heroChoiceButtons.style.display = 'none'; heroWaitMessage.style.display = 'none'; heroYesBtn.classList.remove('selected'); heroNoBtn.classList.remove('selected'); } if (currentPhase === 'summary') { populateSummary(); downloadPdfBtn.style.display = 'inline-block'; downloadPdfBtn.disabled = false; if (thankYouModal && thankYouModal.classList.contains('visible')) { thankYouModal.classList.remove('visible'); setTimeout(() => { thankYouModal.style.display = 'none'; }, 300); } } else { downloadPdfBtn.style.display = 'none'; } resetBtn.disabled = !roomId; copyBtn.disabled = !roomId; resetBtn.style.display = (currentPhase === 'summary' || (thankYouModal && thankYouModal.classList.contains('visible'))) ? 'none' : 'inline-block'; }
        function renderTeams() { const renderList = (teamEl, teamData, countEl) => { teamEl.innerHTML = ''; const currentTeam = teamData || []; if (currentTeam.length > 0) { currentTeam.forEach(nationId => { const nation = allNations.find(n => n.id === nationId); if (nation) { const nationEl = document.createElement('span'); nationEl.className = 'team-nation'; nationEl.innerHTML = `<img class="team-flag" src="https://flagcdn.com/w40/${nation.code}.png" alt="${nation.name}" title="${nation.name} - ${nation.description} (${nation.bonus})"><span style="margin-left: 5px;">${nation.name}</span>`; teamEl.appendChild(nationEl); } else { console.warn("ID nazione non trovato:", nationId); } }); countEl.textContent = currentTeam.length; } else { countEl.textContent = 0; } }; renderList(p1TeamEl, localGameState.player1?.team, p1CountEl); renderList(p2TeamEl, localGameState.player2?.team, p2CountEl); }
        function renderNations() { nationsListEl.innerHTML = ''; const p1Team = localGameState.player1?.team || []; const p2Team = localGameState.player2?.team || []; const selectedIds = new Set([...p1Team, ...p2Team]); const canSelect = localGameState.gamePhase === "draft" && localGameState.currentPlayer === playerRole; allNations.forEach(nation => { const isSelected = selectedIds.has(nation.id); const nationCard = document.createElement('div'); nationCard.className = 'nation-card'; nationCard.dataset.nationId = nation.id; const tooltipHtml = `<div class="nation-tooltip"><strong>${nation.name}</strong><br>Bonus: ${nation.bonus || 'N/D'}<br><i>${nation.description || ''}</i></div>`; nationCard.innerHTML = `<img class="flag" src="https://flagcdn.com/w80/${nation.code}.png" alt="${nation.name}" title="${nation.name}"><div class="name">${nation.name}</div>${tooltipHtml}`; nationCard.onclick = null; nationCard.onmouseover = null; nationCard.onmouseout = null; const tooltipElement = nationCard.querySelector('.nation-tooltip'); if (isSelected) { nationCard.classList.add('disabled'); } else { nationCard.onmouseover = () => { if (tooltipElement) tooltipElement.style.display = 'block'; }; nationCard.onmouseout = () => { if (tooltipElement) tooltipElement.style.display = 'none'; }; if (canSelect) { nationCard.classList.add('available'); nationCard.onclick = () => selectNationWithAnimation(nationCard, nation); } } nationsListEl.appendChild(nationCard); }); }
        function updateGamePhaseDisplay() { const phase = localGameState.gamePhase; let mainTextContent = "Attendere ordini..."; gamePhaseEl.style.color = '#4E3E2D'; let firstChild = gamePhaseEl.firstChild; while(firstChild && firstChild.nodeType !== Node.ELEMENT_NODE && firstChild.id !== 'hero-status-p1' && firstChild.id !== 'hero-status-p2') { gamePhaseEl.removeChild(firstChild); firstChild = gamePhaseEl.firstChild; } if (firstChild && (firstChild.tagName === 'SPAN' || firstChild.nodeType === Node.TEXT_NODE || firstChild.tagName === 'SMALL' || firstChild.tagName === 'BR')) { gamePhaseEl.removeChild(firstChild); } heroStatusP1.style.display = 'none'; heroStatusP1.textContent = ''; heroStatusP2.style.display = 'none'; heroStatusP2.textContent = ''; switch (phase) { case "waiting": const wp1Name = localGameState.player1?.name; const wp2Name = localGameState.player2?.name; if (wp1Name && !wp2Name) { mainTextContent = `Attendere Comando 2... <br><small>Inviare collegamento stanza!</small>`; } else if (!wp1Name && wp2Name) { mainTextContent = `Attendere Comando 1...`; } else if (!wp1Name && !wp2Name) { mainTextContent = `Attendere Comandanti...`; } else { mainTextContent = "Quartier Generale pronto. Attendere inizio mobilitazione..."; } break; case "draft": const dp1Name = localGameState.player1?.name; const dp2Name = localGameState.player2?.name; const dTurnNumber = localGameState.currentPlayer; const dCurrentTurnPlayerName = dTurnNumber === 1 ? dp1Name : dp2Name; if (!dCurrentTurnPlayerName) { mainTextContent = "Attendere..."; break; } if (dTurnNumber === playerRole) { mainTextContent = `<span style="color: #8B0000; font-weight: bold;">Comando ${dTurnNumber}, Vostro Turno!</span> Selezionare nazione.`; } else { mainTextContent = `Attendere Comando ${dTurnNumber} (${dCurrentTurnPlayerName})...`; } break; case "completed": mainTextContent = "Selezione nazioni completata. Preparazione fase Eroi..."; break; case "hero_selection": mainTextContent = "Decisione Schieramento Eroi"; heroStatusP1.textContent = `Comando 1: ${getHeroStatusText(localGameState.player1?.heroChoice)}`; heroStatusP2.textContent = `Comando 2: ${getHeroStatusText(localGameState.player2?.heroChoice)}`; heroStatusP1.style.display = 'block'; heroStatusP2.style.display = 'block'; break; case "summary": mainTextContent = "Riepilogo Finale Selezione"; gamePhaseEl.style.color = '#006400'; break; default: mainTextContent = `Stato Sconosciuto: ${phase}`; gamePhaseEl.style.color = 'red'; } gamePhaseEl.insertAdjacentHTML('afterbegin', mainTextContent); }
        copyBtn.addEventListener('click', () => { playSound('click'); if (!roomId) { alert("Nessuna stanza attiva."); playSound('error'); return; } const cleanUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`; const inviteUrl = `${cleanUrl}?room=${roomId}`; navigator.clipboard.writeText(inviteUrl).then(() => { alert(`Collegamento Stanza Strategica copiato!\n${inviteUrl}`); playSound('complete'); }, (err) => { console.error('Errore copia link:', err); prompt("Copia manuale:", inviteUrl); playSound('error'); }); });
        resetBtn.addEventListener('click', () => { playSound('click'); if (!roomId || !playerRole) { return; } if (confirm("Confermare la ritirata dalla Stanza Strategica?")) { playSound('heroYes'); if (roomRef) { roomRef.off("value"); roomRef = null; } if (!database) { console.error("DB Error"); return; } const playerPath = `/rooms/${roomId}/player${playerRole}`; console.log("Ritirata da:", playerPath); database.ref(playerPath).remove().then(() => { console.log("Ritirata confermata."); handleGameEndCleanup(); }).catch(error => { console.error("Errore Firebase Remove (resetBtn):", error); alert("Errore durante la ritirata: " + error.message); playSound('error'); handleGameEndCleanup(); }); } else { playSound('heroNo'); } });
        function handleGameEndCleanup() { console.log("Cleanup e ritorno a login."); if (roomRef) { roomRef.off("value"); roomRef = null; } clearInterval(timerInterval); timerInterval = null; localGameState = {}; playerRole = null; playerName = ""; roomId = ""; gameContainer.style.display = 'none'; loginContainer.style.display = 'block'; playerNameInput.value = ''; roomIdInput.value = ''; joinBtn.disabled = false; displayRoomId.textContent = ''; displayPlayerName.textContent = ''; displayPlayerRole.textContent = ''; p1TeamEl.innerHTML = ''; p2TeamEl.innerHTML = ''; p1CountEl.textContent = '0'; p2CountEl.textContent = '0'; nationsListEl.innerHTML = ''; gamePhaseEl.innerHTML = 'Attendere ordini...<div class="hero-status" id="hero-status-p1" style="display: none;"></div><div class="hero-status" id="hero-status-p2" style="display: none;"></div>'; timerEl.textContent = ''; if (window.history.replaceState) { const cleanUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`; try { window.history.replaceState({ path: cleanUrl }, '', cleanUrl); } catch (e) { console.warn("URL non pulito:", e); } } }
        try { const urlParams = new URLSearchParams(window.location.search); const roomParam = urlParams.get('room'); if (roomParam) { const sanitizedRoomId = roomParam.trim().toUpperCase(); if (sanitizedRoomId.length > 0 && sanitizedRoomId.length < 10) { roomIdInput.value = sanitizedRoomId; console.log(`ID Stanza precompilato: ${sanitizedRoomId}`); } else { console.warn(`ID Stanza URL non valido: "${roomParam}"`); } } } catch (e) { console.error("Errore parametri URL:", e); } if (!database) { console.error("DB NON PRONTO ALL'AVVIO."); loginContainer.innerHTML = "<p style='color:red'>Errore critico: database non disponibile.</p>"; }

        // Inizializza Audio alla fine, dopo aver definito tutto
        initializeAudio();

    </script>

    <!-- Riferimento Regole Sicurezza (SENZA /draft_history e semplificate) -->
     <!-- ... -->

</body>
</html>
