<!DOCTYPE html>
<html lang="it"> <!-- Verrà aggiornato da JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scelta Nazioni Supremacy 1914 ITA</title> <!-- Verrà aggiornato da JS -->
    <!-- Font Awesome e jsPDF -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- CSS (CON FONT OSWALD + LATO) --- */
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Oswald:wght@400;700&display=swap');

        :root { /* Variabili */
            --color-background: #C1B5A5; --color-container-bg: rgba(245, 235, 215, 0.96); --color-container-border: #A08C70; --color-text-dark: #2E231A; --color-text-medium: #4B3A2A; --color-text-light: #F5F0E5; --color-accent-dark: #800000; --color-accent-medium: #8A704E; --color-accent-light: #B0987C; --color-disabled-bg: #D0C8B8; --color-disabled-border: #A08C70; --color-disabled-text: #70685A; --color-player-bg: #EAE0C8; --color-player-active-bg: #D8CCA8; --color-card-bg: #F8F2E4; --color-card-hover-bg: #FFFBF0; --color-list-bg: rgba(255, 250, 235, 0.95);
            --font-serif: 'Lato', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-serif-display: 'Oswald', Impact, sans-serif;
            --font-sans-serif:'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-mono:'Courier New', Courier, monospace;
            --base-border-radius: 3px; --transition-speed:.25s; --shadow-color: rgba(0, 0, 0, .18); --shadow-color-darker: rgba(0, 0, 0, .30);
         }

         *, ::after, ::before { box-sizing: border-box }
        body { background-image: url(https://clan.cloudflare.steamstatic.com/images/34123292/58502dadd0af1a8c8758d8c8a7f77978d01c0e6a.jpg); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed;
               font-family: var(--font-serif); margin: 0; padding: 25px; color: var(--color-text-dark); min-height: 100vh; line-height: 1.65; overflow-x: hidden; position: relative; -webkit-text-size-adjust: 100% }
        body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-shadow: inset 0 0 100px rgba(0, 0, 0, .25); pointer-events: none; z-index: -1 }
        .container { max-width: 1100px; margin: 25px auto; background-image: url('https://www.transparenttextures.com/patterns/old-paper.png'); background-color: var(--color-container-bg); padding: 35px; border-radius: var(--base-border-radius); box-shadow: 0 10px 35px var(--shadow-color-darker), inset 0 0 15px rgba(0,0,0,0.1); border: 2px solid var(--color-container-border); position: relative }
        h1 { text-align: center; color: var(--color-accent-dark); margin-top: 0; margin-bottom: 40px; font-family: var(--font-serif-display); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--color-accent-light); padding-bottom: 18px; font-size: 2.3em; text-shadow: 1px 1px 0px var(--color-text-light), 2px 2px 3px rgba(0,0,0,0.2); }
        h2, h3 { font-family: var(--font-serif-display); font-weight: 700; text-transform: uppercase; color: var(--color-text-medium); letter-spacing: 1px; margin-bottom: 15px; }
        #alliance-select { padding: 12px; margin: 10px 0; border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); width: 100%; box-sizing: border-box; background-color: #FFFDF5; color: var(--color-text-dark); font-family: var(--font-serif); font-size: 1em; transition: all var(--transition-speed) ease; cursor: pointer; }
        #alliance-select:focus { border-color: var(--color-text-medium); outline: none; box-shadow: 0 0 8px rgba(90, 71, 53, .4); background-color: #fff; }
        #alliance-select:disabled { cursor: not-allowed; background-color: var(--color-disabled-bg); opacity: 0.7; }
        .alliance-info { display: flex; align-items: center; margin-bottom: 10px; min-height: 30px; margin-top: 5px; }
        .alliance-logo { width: 30px; height: 30px; object-fit: contain; margin-right: 8px; vertical-align: middle; background-color: rgba(0,0,0,0.05); border-radius: 3px; display: inline-block; image-rendering: -webkit-optimize-contrast; }
        .alliance-name { font-size: 0.95em; color: var(--color-text-medium); font-style: italic; font-weight: bold; font-family: var(--font-serif); }
        .summary-alliance { margin-bottom: 8px; display: flex; align-items: center; }
        .summary-alliance strong { margin-right: 5px; }
        .summary-alliance .alliance-logo { width: 20px; height: 20px; margin-right: 5px; }
        .game-phase { margin-bottom: 30px; padding: 20px 30px; background-color: rgba(210, 190, 160, 0.95); border-radius: 0; text-align: center; font-weight: 700; border: 1px solid var(--color-accent-medium); color: var(--color-text-dark); min-height: 50px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-family: var(--font-serif-display); font-size: 1.25em; text-transform: uppercase; letter-spacing: 1px; transition: background-color var(--transition-speed) ease; box-shadow: 0 2px 5px var(--shadow-color), inset 0 0 10px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
        .game-phase .main-phase-text { display: block; width: 100%; margin-bottom: 5px; position: relative; z-index: 1; }
        .game-phase span[style*="color"] { text-shadow: 1px 1px 1px rgba(255, 255, 255, .4) }
        .hero-status { font-size: .85em; font-style: italic; margin-top: 5px; color: var(--color-text-dark); display: block; width: 100%; font-family: var(--font-serif); text-transform: none; letter-spacing: normal; position: relative; z-index: 1;}
        .timer-container { text-align: center; margin: 25px 0 }
        .timer { font-size: 1.5em; color: var(--color-accent-dark); margin: 0 0 8px; text-align: center; min-height: 1.5em; font-family: var(--font-mono); background-color: rgba(248, 244, 232, .8); padding: 5px 10px; display: inline-block; border-radius: var(--base-border-radius); border: 1px solid rgba(139, 0, 0, .4); box-shadow: 0 1px 3px var(--shadow-color) }
        .timer-bar-container { width: 250px; max-width: 80%; height: 8px; background-color: rgba(0, 0, 0, .1); border: 1px solid var(--color-accent-light); border-radius: 4px; margin: 0 auto; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0, 0, 0, .1) }
        .timer-bar { height: 100%; width: 100%; background: linear-gradient(to right, var(--color-accent-dark), #b50000); border-radius: 3px; transition: width 1s linear }
        .players-container { display: flex; justify-content: space-between; margin-bottom: 40px; flex-wrap: wrap; gap: 25px }
        .player { width: 100%; padding: 25px; background: linear-gradient(to bottom, var(--color-player-bg), #D8CCA8); border-radius: var(--base-border-radius); box-shadow: 0 2px 6px var(--shadow-color), inset 0 0 0 1px var(--color-accent-light); border: 1px solid var(--color-container-border); box-sizing: border-box; transition: all var(--transition-speed) ease; border-left: 6px solid transparent; }
        @media (min-width:768px) { .player { width: calc(50% - 13px) } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 2px 6px var(--shadow-color), inset 0 0 0 1px var(--color-accent-dark); } 50% { transform: scale(1.02); box-shadow: 0 5px 15px var(--shadow-color-darker), inset 0 0 0 1px var(--color-accent-dark); } 100% { transform: scale(1); box-shadow: 0 2px 6px var(--shadow-color), inset 0 0 0 1px var(--color-accent-dark); } }
        .player.active { border-left-color: var(--color-accent-dark); box-shadow: 0 4px 12px var(--shadow-color-darker), inset 0 0 0 1px var(--color-accent-dark); }
        .player.turn-pulse { animation: pulse .6s ease-in-out }
        .player h2 { margin-top: 0; border-bottom: 1px solid var(--color-accent-light); padding-bottom: 12px; font-size: 1.25em; margin-bottom: 10px; }
        .hero-selection-section, .summary-section { margin-top: 30px; padding: 25px; background-color: rgba(216, 200, 168, .8); border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); text-align: center }
        .hero-selection-section h3, .summary-section h3 { margin-top: 0; border-bottom: 1px solid var(--color-accent-light); padding-bottom: 10px; margin-bottom: 20px }
        .hero-choice-buttons button { margin: 0 10px; font-size: .95em; padding: 8px 18px }
        .hero-choice-buttons button.selected { background: linear-gradient(to bottom, var(--color-accent-dark), #5c0000); border-color: var(--color-accent-dark); color: var(--color-text-light); cursor: default }
        .summary-details { display: flex; flex-direction: column; gap: 15px; text-align: left; margin-bottom: 15px }
        .summary-player { width: 100% }
        .summary-player ul { list-style: none; padding-left: 0; margin-top: 5px }
        .summary-player li { margin-bottom: 4px; font-size: .95em; display: flex; align-items: center; font-family: var(--font-serif); }
        .summary-player .hero-decision { font-weight: 700 }
        .summary-player .hero-decision .yes { color: darkgreen }
        .summary-player .hero-decision .no { color: var(--color-accent-dark) }
        @media (min-width:600px) { .summary-details { flex-direction: row; justify-content: space-around; gap: 20px } .summary-player { width: calc(50% - 20px); min-width: 280px } }
        #download-confirmation { font-style: italic; color: var(--color-text-medium); margin-top: 15px; font-size: .9em; font-family: var(--font-serif); }
        .nations-container { margin-top: 25px }
        .nations-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 20px 0 }
        @media (max-width:900px) { .nations-grid { grid-template-columns: repeat(4, 1fr) } }
        @media (max-width:700px) { .nations-grid { grid-template-columns: repeat(3, 1fr); gap: 10px } }
        @media (max-width:480px) { .nations-grid { grid-template-columns: repeat(3, 1fr); gap: 8px } }
        .nation-card { border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); padding: 10px; text-align: center; cursor: default; transition: all var(--transition-speed) ease-in-out; background: linear-gradient(to bottom, var(--color-card-bg), #E8E0D0); box-shadow: 0 2px 5px var(--shadow-color); position: relative; overflow: hidden; }
        .nation-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(rgba(255,255,255,0.05), rgba(0,0,0,0.05)); opacity: 0; transition: opacity var(--transition-speed) ease; pointer-events: none; }
        .nation-card.available:hover { border-color: var(--color-accent-medium); background: linear-gradient(to bottom, var(--color-card-hover-bg), #F0E8D8); cursor: pointer; transform: translateY(-6px) scale(1.04); box-shadow: 0 10px 20px var(--shadow-color-darker); z-index: 10; }
        .nation-card.available:hover::before { opacity: 1; }
        .nation-card.available:active { transform: translateY(-2px) scale(1.01); box-shadow: 0 4px 10px var(--shadow-color) }
        .nation-card.selecting { opacity: .7; transform: scale(.95); transition: opacity .1s ease, transform .1s ease }
        .nation-card.disabled { opacity: .55; cursor: not-allowed; background: var(--color-disabled-bg); box-shadow: inset 0 2px 4px rgba(0, 0, 0, .1); border-color: var(--color-disabled-border); transform: none !important }
        .nation-card.disabled:hover { transform: none; box-shadow: inset 0 2px 4px rgba(0, 0, 0, .1) }
        .flag { width: 70px; height: auto; aspect-ratio: 8/5; object-fit: cover; border: 1px solid var(--color-container-border); margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; filter: sepia(10%); border-radius: 3px; box-shadow: 0 1px 2px rgba(0, 0, 0, .1); }
        @media (max-width:480px) { .flag { width: 60px; margin-bottom: 8px } }
        .nation-card.disabled .flag { filter: grayscale(95%) opacity(60%); box-shadow: none }
        .nation-card .name { font-weight: bold; font-family: var(--font-serif); font-size: 1em; color: var(--color-text-dark); line-height: 1.3 }
        @media (max-width:480px) { .nation-card .name { font-size: .9em; } }
        .nation-tooltip { display: none; position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background-color: rgba(45, 35, 25, .95); color: var(--color-text-light); padding: 8px 12px; border-radius: var(--base-border-radius); font-size: .85em; font-family: var(--font-sans-serif); white-space: nowrap; z-index: 20; border: 1px solid var(--color-accent-light); box-shadow: 0 2px 5px rgba(0, 0, 0, .3); pointer-events: none }
        .nation-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: rgba(45, 35, 25, .95) transparent transparent transparent }
        @media (hover:none)and (pointer:coarse) { .nation-tooltip { display: none !important } .nation-card.available:hover { transform: none; box-shadow: 0 3px 7px var(--shadow-color); cursor: pointer } }
        .team-list { min-height: 100px; border: 1px dashed var(--color-accent-medium); border-radius: var(--base-border-radius); padding: 10px; margin-top: 15px; background: var(--color-list-bg); box-shadow: inset 0 1px 5px rgba(0, 0, 0, .07) }
        .team-nation { display: inline-flex; align-items: center; margin: 4px; padding: 5px 10px; background: var(--color-player-bg); border-radius: 15px; font-size: .85em; border: 1px solid var(--color-container-border); box-shadow: 0 1px 3px var(--shadow-color); transition: transform .2s ease; font-family: var(--font-serif); }
        .team-nation:hover { transform: scale(1.05) }
        .team-flag { width: 18px; height: 12px; margin-right: 7px; border: 1px solid #aaa; object-fit: cover; filter: sepia(10%); border-radius: 1px; vertical-align: middle; }
        .controls { text-align: center; margin-top: 35px }
        button i.fa-solid { margin-right: 8px; vertical-align: middle; margin-top: -2px; }
        #copy-btn { padding: 10px 15px }
        #copy-btn i.fa-solid { margin-right: 0; margin-left: 0 }
        #copy-btn span { display: none }
        #reset-btn i.fa-solid { margin-right: 6px }
        button {
            font-family: var(--font-serif-display); font-weight: 700;
            background: linear-gradient(to bottom, var(--color-accent-medium), #6A543E);
            color: var(--color-text-light); border: 1px solid #503F2E;
            padding: 12px 24px; border-radius: 2px; cursor: pointer;
            font-size: 1em; text-transform: uppercase;
            letter-spacing: 1px; transition: all var(--transition-speed) ease; margin: 6px;
            box-shadow: 0 4px 8px var(--shadow-color-darker), inset 0 1px 0 rgba(255,255,255,0.1);
            text-shadow: 1px 1px 1px rgba(0, 0, 0, .4);
        }
        @media (max-width:480px) { button { padding: 10px 18px; font-size: .95em } }
        button:hover:not(:disabled) { background: linear-gradient(to bottom, var(--color-accent-light), #7A6044); border-color: #40301E; box-shadow: 0 6px 12px var(--shadow-color-darker), inset 0 1px 1px rgba(255,255,255,0.15); transform: translateY(-3px); }
        button:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 1px 3px var(--shadow-color), inset 0 1px 3px rgba(0,0,0,0.2); }
        button:disabled { background: var(--color-disabled-bg); border-color: var(--color-disabled-border); color: var(--color-disabled-text); cursor: not-allowed; opacity: .6; box-shadow: none; text-shadow: none; transform: none }
        .login-container { text-align: center; margin: 50px auto; max-width: 400px; padding: 30px; background-color: rgba(248, 244, 232, .93); border-radius: var(--base-border-radius); box-shadow: 0 5px 25px var(--shadow-color-darker); border: 1px solid var(--color-container-border) }
        .login-container h3 { color: var(--color-text-medium); font-family: var(--font-serif-display); margin-bottom: 25px; text-transform: uppercase; font-size: 1.3em }
        input[type="text"] { padding: 12px; margin: 10px 0; border: 1px solid var(--color-accent-light); border-radius: var(--base-border-radius); width: 100%; box-sizing: border-box; background-color: #FFFDF5; color: var(--color-text-dark); font-family: var(--font-serif); font-size: 1em; transition: all var(--transition-speed) ease }
        input[type="text"]:focus { border-color: var(--color-text-medium); outline: none; box-shadow: 0 0 8px rgba(90, 71, 53, .4); background-color: #fff }
        .room-info { background-color: rgba(216, 200, 168, .92); padding: 10px 15px; border-radius: var(--base-border-radius); margin-bottom: 25px; text-align: center; border: 1px solid var(--color-accent-light); font-size: .95em; color: #4e3e2d; box-shadow: inset 0 0 5px rgba(0, 0, 0, .1); font-family: var(--font-serif); }
        .room-info strong { color: var(--color-text-dark); font-weight: 700 }
        .room-info button { padding: 6px 10px; font-size: 1em; line-height: 1; margin-left: 15px; vertical-align: middle; background-color: var(--color-accent-light); border-color: var(--color-text-medium) }
        .room-info button:hover:not(:disabled) { background-color: #867767; border-color: var(--color-text-dark) }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .65); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility 0s linear .3s; padding: 20px }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity .3s ease, visibility 0s linear 0s }
        .modal-content { background-image: url('https://www.transparenttextures.com/patterns/old-paper.png'); background-color: var(--color-container-bg); padding: 35px 45px; border-radius: var(--base-border-radius); box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 2px solid var(--color-container-border); max-width: 550px; width: 95%; text-align: center; position: relative; transform: translateY(-20px) scale(.95); transition: transform .3s ease-out, opacity .3s ease-out; opacity: 0 }
        .modal-overlay.visible .modal-content { transform: translateY(0) scale(1); opacity: 1 }
        .modal-content h2 { color: var(--color-accent-dark); margin-top: 0; margin-bottom: 20px; font-family: var(--font-serif-display); font-size: 1.5em }
        .modal-content p { margin-bottom: 12px; line-height: 1.7; color: var(--color-text-dark); font-family: var(--font-serif); }
        .modal-content p small { color: var(--color-text-medium) }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: 0 0; border: none; font-size: 2.2em; color: var(--color-accent-light); cursor: pointer; padding: 0 5px; line-height: 1; transition: color var(--transition-speed) ease, transform .2s ease }
        .modal-close-btn:hover { color: var(--color-text-dark); transform: scale(1.1) }

        /* Stile per i pulsanti lingua */
        .language-selector {
            text-align: center;
            margin-bottom: 20px;
            margin-top: -10px;
            min-height: 30px;
        }
        .language-selector button {
            background: transparent;
            border: 1px solid var(--color-accent-light);
            color: var(--color-text-medium);
            /* Padding modificato per spazio bandiera */
            padding: 5px 12px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: var(--base-border-radius);
            font-family: var(--font-serif);
            font-size: 0.9em;
            opacity: 0.7;
            transition: all 0.2s ease;
            box-shadow: none;
            text-shadow: none;
            text-transform: none;
            display: inline-block;
            /* Allinea bandiera e testo */
            vertical-align: middle;
        }
        .language-selector button:hover:not(.active) {
            background-color: rgba(0,0,0,0.05);
            opacity: 1;
             transform: none;
             box-shadow: none;
             border-color: var(--color-text-medium);
        }
        .language-selector button.active {
            background-color: var(--color-accent-light);
            color: var(--color-text-dark);
            border-color: var(--color-accent-medium);
            font-weight: bold;
            opacity: 1;
             box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
             cursor: default;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 data-translate-key="appTitle">Scelta Nazioni Supremacy 1914 ITA</h1>

        <div id="login-container" class="login-container">
            <!-- SELETTORE LINGUA CON BANDIERE -->
            <div class="language-selector">
                <button id="lang-it" data-lang="it">🇮🇹 Italiano</button>
                <button id="lang-en" data-lang="en">🇬🇧 English</button>
            </div>
            <!-- / SELETTORE LINGUA CON BANDIERE -->

            <h3 data-translate-key="loginTitle">Accesso Ufficiali</h3>
            <input type="text" id="player-name" data-translate-key="loginPlaceholderName" data-translate-attr="placeholder" placeholder="Nome in codice" required>
            <select id="alliance-select" required disabled>
                <option value="" disabled selected>-- Caricamento Alleanze... --</option>
            </select>
            <input type="text" id="room-id" data-translate-key="loginPlaceholderRoom" data-translate-attr="placeholder" placeholder="ID Stanza Strategica (o lasciare vuoto)">
            <button id="join-btn" disabled><i class="fa-solid fa-right-to-bracket"></i> <span data-translate-key="loginButtonJoin">Entra / Crea Stanza</span></button>
             <p id="auth-status" style="font-size: 0.8em; margin-top: 15px; color: var(--color-text-medium);" data-translate-key="authStatusInitializing">Inizializzazione servizi...</p>
        </div>

        <!-- Contenitore Gioco -->
        <div id="game-container" style="display: none; opacity: 0;">
             <div class="room-info">
                 <span data-translate-key="roomInfoLabel">Stanza</span>: <strong id="display-room-id"></strong> |
                 <span data-translate-key="officerLabel">Ufficiale</span>: <strong id="display-player-name"></strong> |
                 <span data-translate-key="designationLabel">Designazione</span>: <strong id="display-player-role"></strong>
                 <button id="copy-btn" data-translate-key="copyLinkButtonTitle" data-translate-attr="title" title="Copia Collegamento Stanza"><i class="fa-solid fa-link"></i></button>
            </div>
             <div class="game-phase" id="game-phase">
                 <span class="main-phase-text"></span>
                 <div class="hero-status" id="hero-status-p1" style="display: none;"></div>
                 <div class="hero-status" id="hero-status-p2" style="display: none;"></div>
            </div>
             <div class="timer-container"> <div class="timer" id="timer"></div> <div class="timer-bar-container" id="timer-bar-container" style="display: none;"> <div class="timer-bar" id="timer-bar"></div> </div> </div>
             <div class="players-container">
                 <div class="player" id="player1">
                     <h2>Generale 1</h2>
                     <div class="alliance-info" id="p1-alliance-info"> <img src="" alt="Logo Alleanza" class="alliance-logo" style="display: none;"> <span class="alliance-name"></span> </div>
                     <div><span data-translate-key="nationsMobilizedLabel">Nazioni mobilitate</span>: <span id="p1-count">0</span>/5</div> <div class="team-list" id="p1-team"></div>
                </div>
                 <div class="player" id="player2">
                     <h2>Generale 2</h2>
                     <div class="alliance-info" id="p2-alliance-info"> <img src="" alt="Logo Alleanza" class="alliance-logo" style="display: none;"> <span class="alliance-name"></span> </div>
                     <div><span data-translate-key="nationsMobilizedLabel">Nazioni mobilitate</span>: <span id="p2-count">0</span>/5</div> <div class="team-list" id="p2-team"></div>
                </div>
             </div>
             <div class="nations-container" id="nations-container">
                 <h3 data-translate-key="availableNationsTitle">Nazioni Disponibili per l'Alleanza:</h3> <div class="nations-grid" id="nations-list"></div>
            </div>
             <div class="hero-selection-section" id="hero-selection-section" style="display: none;">
                 <h3 data-translate-key="heroDecisionTitle">Decisione Schieramento Eroi</h3>
                 <p data-translate-key="heroDecisionPrompt">Confermare l'utilizzo degli Eroi per questa sfida?</p>
                 <div class="hero-choice-buttons" id="hero-choice-buttons">
                     <button id="hero-yes-btn"><i class="fa-solid fa-shield-halved"></i> <span data-translate-key="heroButtonYes">Schiera Eroi</span></button>
                     <button id="hero-no-btn"><i class="fa-solid fa-ban"></i> <span data-translate-key="heroButtonNo">Nessun Eroe</span></button>
                 </div>
                 <p id="hero-wait-message" style="display: none; margin-top: 15px; font-style: italic;" data-translate-key="heroWaitMessage">Decisione registrata. Attendere l'avversario...</p>
            </div>
             <div class="summary-section" id="summary-section" style="display: none;">
                 <h3 data-translate-key="summaryTitle">Riepilogo Finale Selezione</h3>
                 <div class="summary-details">
                     <div class="summary-player" id="summary-p1">
                         <h4>Generale 1: <span id="summary-p1-name"></span></h4>
                         <div class="summary-alliance"> <strong><span data-translate-key="summaryAllianceLabel">Alleanza</span>:</strong> <img src="" alt="" class="summary-alliance-logo alliance-logo" style="display: none;"> <span id="summary-p1-alliance-name"></span> </div>
                         <strong><span data-translate-key="summaryNationsLabel">Nazioni</span>:</strong> <ul id="summary-p1-nations"></ul>
                         <strong><span data-translate-key="summaryHeroesLabel">Eroi</span>:</strong> <span class="hero-decision" id="summary-p1-hero"></span>
                    </div>
                     <div class="summary-player" id="summary-p2">
                         <h4>Generale 2: <span id="summary-p2-name"></span></h4>
                         <div class="summary-alliance"> <strong><span data-translate-key="summaryAllianceLabel">Alleanza</span>:</strong> <img src="" alt="" class="summary-alliance-logo alliance-logo" style="display: none;"> <span id="summary-p2-alliance-name"></span> </div>
                         <strong><span data-translate-key="summaryNationsLabel">Nazioni</span>:</strong> <ul id="summary-p2-nations"></ul>
                         <strong><span data-translate-key="summaryHeroesLabel">Eroi</span>:</strong> <span class="hero-decision" id="summary-p2-hero"></span>
                    </div>
                 </div>
                 <button id="download-pdf-btn" style="margin-top: 25px;"><i class="fa-solid fa-file-pdf"></i> <span data-translate-key="downloadPdfButton">Scarica Riepilogo (PDF)</span></button>
            </div>
            <div class="controls">
                <button id="reset-btn"><i class="fa-solid fa-flag"></i> <span data-translate-key="retreatButton">Ritirata</span></button>
            </div>
        </div><!-- Fine game-container -->
    </div> <!-- Fine container -->

    <!-- Modal Ringraziamento -->
    <div id="thank-you-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-btn" id="modal-close-btn" data-translate-key="modalCloseButtonTitle" data-translate-attr="title" title="Chiudi">×</button>
            <h2 data-translate-key="modalTitleComplete">Selezione Completata!</h2>
            <p data-translate-key="modalMessageComplete">Lo Staff Supremacy 1914 - 2025 ti ringrazia per la collaborazione e augura a tutta la squadra una buona sfida!</p>
            <p><small data-translate-key="modalPdfDownloaded">(Il riepilogo PDF è stato scaricato.)</small></p>
        </div>
    </div>

    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyBMSMS7TCBVATqdoCqNX99AriyiSpy9y8E", authDomain: "supremacy-web.firebaseapp.com", databaseURL: "https://supremacy-web-default-rtdb.europe-west1.firebasedatabase.app", projectId: "supremacy-web", storageBucket: "supremacy-web.appspot.com", messagingSenderId: "30781020744", appId: "1:30781020744:web:81eee78242a060a9d6167d", measurementId: "G-VTMYEXEDSW" };

        // --- Variabili Globali per Logica di Gioco ---
        let database; let auth; let isAuthComplete = false; let localGameState = {};
        let playerRole = null; let playerName = ""; let roomId = ""; let timerInterval = null;
        let roomRef = null; let turnStartTime = 0;
        let timerDuration = 3600000; // 1 ORA
        let audioUnlocked = false; let sounds = {};
        let currentLanguage = 'it'; // Default, verrà sovrascritto

        // --- OGGETTO TRADUZIONI (i18n) ---
        const translations = {
            it: {
                appTitle: "Scelta Nazioni Supremacy 1914 ITA",
                loginTitle: "Accesso Ufficiali",
                loginPlaceholderName: "Nome in codice",
                loginAllianceSelectDefault: "-- Seleziona Alleanza --",
                loginAllianceLoading: "-- Caricamento Alleanze... --",
                loginPlaceholderRoom: "ID Stanza Strategica (o lasciare vuoto)",
                loginButtonJoin: "Entra / Crea Stanza",
                authStatusInitializing: "Inizializzazione servizi...",
                authStatusAuthenticating: "Autenticazione...",
                authStatusReady: "Servizi pronti.",
                authStatusError: "Errore Auth: {error}",
                roomInfoLabel: "Stanza",
                officerLabel: "Ufficiale",
                designationLabel: "Designazione",
                copyLinkButtonTitle: "Copia Collegamento Stanza",
                gamePhaseWaitingOrders: "Attendere ordini...",
                gamePhaseWaitingP2: "Attendere Generale 2... <br><small style='font-family:var(--font-serif); text-transform:none; font-weight:normal;'>Inviare link stanza!</small>",
                gamePhaseWaitingP1: "Attendere Generale 1...",
                gamePhaseWaitingGenerals: "Attendere Generali...",
                gamePhaseHqReady: "Quartier Generale pronto...",
                gamePhaseYourTurn: "<span style=\"color: var(--color-accent-dark); font-weight: bold;\">Generale {playerNum}, Vostro Turno!</span><br><small style='font-family:var(--font-serif); text-transform:none; font-weight:normal;'>Selezionare nazione.</small>",
                gamePhaseWaitingOpponent: "Attendere Generale {playerNum} ({playerName})...",
                gamePhaseDraftComplete: "Selezione completata. Preparo fase Eroi...",
                gamePhaseHeroSelection: "Decisione Schieramento Eroi",
                gamePhaseSummary: "Riepilogo Finale Selezione",
                gamePhaseStatusUnknown: "Stato Sconosciuto: {phase}",
                generalLabel: "Generale",
                nationsMobilizedLabel: "Nazioni mobilitate",
                playerInfoWaiting: "(Attendere)",
                availableNationsTitle: "Nazioni Disponibili per l'Alleanza:",
                heroDecisionTitle: "Decisione Schieramento Eroi",
                heroDecisionPrompt: "Confermare l'utilizzo degli Eroi per questa sfida?",
                heroButtonYes: "Schiera Eroi",
                heroButtonNo: "Nessun Eroe",
                heroWaitMessage: "Decisione registrata. Attendere l'avversario...",
                heroStatusDeployed: "Eroi Schierati",
                heroStatusNone: "Nessun Eroe",
                heroStatusWaiting: "In attesa...",
                summaryTitle: "Riepilogo Finale Selezione",
                summaryAllianceLabel: "Alleanza",
                summaryNationsLabel: "Nazioni",
                summaryHeroesLabel: "Eroi",
                summaryHeroDecisionYes: "Si",
                summaryHeroDecisionNo: "No",
                summaryHeroDecisionNA: "N/D",
                summaryNoNations: "- Nessuna nazione -",
                summaryUnknownNation: "ID Sconosciuto: {id}",
                downloadPdfButton: "Scarica Riepilogo (PDF)",
                retreatButton: "Ritirata",
                nationBonusLabel: "Bonus",
                nationDescriptionLabel: "Descrizione",
                modalTitleComplete: "Selezione Completata!",
                modalMessageComplete: "Lo Staff Supremacy 1914 - 2025 ti ringrazia per la collaborazione e augura a tutta la squadra una buona sfida!",
                modalPdfDownloaded: "(Il riepilogo PDF è stato scaricato.)",
                modalCloseButtonTitle: "Chiudi",
                alertErrorAuthGeneric: "Errore auth ({code}). Impossibile continuare.",
                alertErrorFirebaseInit: "Errore Init Firebase: {message}",
                alertErrorAuthNotCompleted: "Autenticazione non completata.",
                alertErrorMissingName: "Nome in codice mancante.",
                alertErrorMissingAlliance: "Selezionare un'alleanza.",
                alertErrorDbError: "Errore connessione database.",
                alertErrorServices: "Errore servizi Firebase.",
                alertErrorRoomFull: "Stanza piena!",
                alertErrorRoomNotFound: "Stanza non trovata!",
                alertErrorPermissionDenied: "Errore Permesso Lettura Stanza.",
                alertErrorRoomConnection: "Errore connessione stanza: {message}",
                alertErrorNoUserForInit: "Errore autenticazione durante l'inizializzazione.",
                alertErrorInitRoom: "Errore inizializzazione stanza: {message}",
                alertErrorVerifyRoom: "Errore verifica stanza: {message}",
                alertErrorRoomClosed: "Stanza Chiusa.",
                alertErrorFirebaseListener: "Errore connessione: {message}",
                alertErrorGameStart: "Errore avvio gioco: {message}.",
                alertErrorPdfLib: "Errore libreria PDF.",
                alertErrorPdfData: "Errore dati per PDF.",
                alertErrorCreatePdf: "Errore creazione PDF.",
                alertErrorSelectNation: "Errore selezione nazione: {message}",
                alertErrorHeroChoice: "Errore scelta eroe: {message}",
                alertErrorRetreatUidMismatch: "Errore identità durante la ritirata.",
                alertErrorRetreatRemove: "Errore durante la ritirata: {message}",
                alertErrorRetreatVerify: "Errore verifica durante la ritirata.",
                alertErrorNoRoomToCopy: "Nessuna stanza selezionata per copiare il link.",
                confirmRetreat: "Confermi la ritirata?",
                promptCopyManually: "Copia manualmente il link:",
                nationName_1: "Marocco", nationBonus_1: "Posizione strategica", nationDesc_1: "Crocevia tra Africa ed Europa",
                nationName_2: "Spagna", nationBonus_2: "Esplorazione +10%", nationDesc_2: "Terra di conquistadores",
                nationName_3: "Francia", nationBonus_3: "Diplomazia +15%", nationDesc_3: "Terra di rivoluzioni e vino",
                nationName_4: "Gran Bretagna", nationBonus_4: "Commercio +15%", nationDesc_4: "Impero marittimo storico",
                nationName_5: "Germania", nationBonus_5: "Produzione +20%", nationDesc_5: "Potenza industriale europea",
                nationName_6: "Italia", nationBonus_6: "Cultura +10%", nationDesc_6: "Patria dell'arte e della cucina",
                nationName_7: "Austria", nationBonus_7: "Musica +10%", nationDesc_7: "Cuore dell'Europa centrale",
                nationName_8: "Impero Ottomano", nationBonus_8: "Posizione +15%", nationDesc_8: "Crocevia tra continenti",
                nationName_9: "Russia", nationBonus_9: "Territorio +25%", nationDesc_9: "Vasta nazione euroasiatica",
                nationName_10: "Svezia", nationBonus_10: "Innovazione +10%", nationDesc_10: "Terra di tecnologia e natura",
            },
            en: {
                appTitle: "Supremacy 1914 Nation Draft ENG",
                loginTitle: "Officer Login",
                loginPlaceholderName: "Codename",
                loginAllianceSelectDefault: "-- Select Alliance --",
                loginAllianceLoading: "-- Loading Alliances... --",
                loginPlaceholderRoom: "Strategic Room ID (or leave empty)",
                loginButtonJoin: "Join / Create Room",
                authStatusInitializing: "Initializing services...",
                authStatusAuthenticating: "Authenticating...",
                authStatusReady: "Services ready.",
                authStatusError: "Auth Error: {error}",
                roomInfoLabel: "Room",
                officerLabel: "Officer",
                designationLabel: "Designation",
                copyLinkButtonTitle: "Copy Room Link",
                gamePhaseWaitingOrders: "Awaiting orders...",
                gamePhaseWaitingP2: "Waiting for General 2... <br><small style='font-family:var(--font-serif); text-transform:none; font-weight:normal;'>Share the room link!</small>",
                gamePhaseWaitingP1: "Waiting for General 1...",
                gamePhaseWaitingGenerals: "Waiting for Generals...",
                gamePhaseHqReady: "Headquarters ready...",
                gamePhaseYourTurn: "<span style=\"color: var(--color-accent-dark); font-weight: bold;\">General {playerNum}, Your Turn!</span><br><small style='font-family:var(--font-serif); text-transform:none; font-weight:normal;'>Select a nation.</small>",
                gamePhaseWaitingOpponent: "Waiting for General {playerNum} ({playerName})...",
                gamePhaseDraftComplete: "Selection complete. Preparing Hero phase...",
                gamePhaseHeroSelection: "Hero Deployment Decision",
                gamePhaseSummary: "Final Selection Summary",
                gamePhaseStatusUnknown: "Unknown Status: {phase}",
                generalLabel: "General",
                nationsMobilizedLabel: "Nations mobilized",
                playerInfoWaiting: "(Waiting)",
                availableNationsTitle: "Available Nations for the Alliance:",
                heroDecisionTitle: "Hero Deployment Decision",
                heroDecisionPrompt: "Confirm the use of Heroes for this challenge?",
                heroButtonYes: "Deploy Heroes",
                heroButtonNo: "No Heroes",
                heroWaitMessage: "Decision registered. Waiting for opponent...",
                heroStatusDeployed: "Heroes Deployed",
                heroStatusNone: "No Heroes",
                heroStatusWaiting: "Waiting...",
                summaryTitle: "Final Selection Summary",
                summaryAllianceLabel: "Alliance",
                summaryNationsLabel: "Nations",
                summaryHeroesLabel: "Heroes",
                summaryHeroDecisionYes: "Yes",
                summaryHeroDecisionNo: "No",
                summaryHeroDecisionNA: "N/A",
                summaryNoNations: "- No nations -",
                summaryUnknownNation: "Unknown ID: {id}",
                downloadPdfButton: "Download Summary (PDF)",
                retreatButton: "Retreat",
                nationBonusLabel: "Bonus",
                nationDescriptionLabel: "Description",
                modalTitleComplete: "Selection Completed!",
                modalMessageComplete: "The Supremacy 1914 - 2025 Staff thanks you for your cooperation and wishes the entire team a good challenge!",
                modalPdfDownloaded: "(The PDF summary has been downloaded.)",
                modalCloseButtonTitle: "Close",
                alertErrorAuthGeneric: "Auth error ({code}). Cannot continue.",
                alertErrorFirebaseInit: "Firebase Init Error: {message}",
                alertErrorAuthNotCompleted: "Authentication not complete.",
                alertErrorMissingName: "Codename missing.",
                alertErrorMissingAlliance: "Select an alliance.",
                alertErrorDbError: "Database connection error.",
                alertErrorServices: "Firebase services error.",
                alertErrorRoomFull: "Room full!",
                alertErrorRoomNotFound: "Room not found!",
                alertErrorPermissionDenied: "Room Read Permission Error.",
                alertErrorRoomConnection: "Room connection error: {message}",
                alertErrorNoUserForInit: "Authentication error during initialization.",
                alertErrorInitRoom: "Room init error: {message}",
                alertErrorVerifyRoom: "Room verification error: {message}",
                alertErrorRoomClosed: "Room Closed.",
                alertErrorFirebaseListener: "Connection error: {message}",
                alertErrorGameStart: "Error starting game: {message}.",
                alertErrorPdfLib: "PDF library error.",
                alertErrorPdfData: "PDF data error.",
                alertErrorCreatePdf: "Error creating PDF.",
                alertErrorSelectNation: "Error selecting nation: {message}",
                alertErrorHeroChoice: "Error choosing hero: {message}",
                alertErrorRetreatUidMismatch: "Identity error during retreat.",
                alertErrorRetreatRemove: "Error during retreat: {message}",
                alertErrorRetreatVerify: "Verification error during retreat.",
                alertErrorNoRoomToCopy: "No room selected to copy link.",
                confirmRetreat: "Confirm retreat?",
                promptCopyManually: "Manual copy link:",
                nationName_1: "Morocco", nationBonus_1: "Strategic position", nationDesc_1: "Crossroads between Africa and Europe",
                nationName_2: "Spain", nationBonus_2: "Exploration +10%", nationDesc_2: "Land of conquistadores",
                nationName_3: "France", nationBonus_3: "Diplomacy +15%", nationDesc_3: "Land of revolutions and wine",
                nationName_4: "Great Britain", nationBonus_4: "Trade +15%", nationDesc_4: "Historic maritime empire",
                nationName_5: "Germany", nationBonus_5: "Production +20%", nationDesc_5: "European industrial power",
                nationName_6: "Italy", nationBonus_6: "Culture +10%", nationDesc_6: "Home of art and cuisine",
                nationName_7: "Austria", nationBonus_7: "Music +10%", nationDesc_7: "Heart of Central Europe",
                nationName_8: "Ottoman Empire", nationBonus_8: "Position +15%", nationDesc_8: "Crossroads of continents",
                nationName_9: "Russia", nationBonus_9: "Territory +25%", nationDesc_9: "Vast Eurasian nation",
                nationName_10: "Sweden", nationBonus_10: "Innovation +10%", nationDesc_10: "Land of technology and nature",
            }
        };

        // --- Array e Costanti Statiche ---
        const { jsPDF } = window.jspdf;
        const allNations = [ { id: 1, code: "ma" }, { id: 2, code: "es" }, { id: 3, code: "fr" }, { id: 4, code: "gb" }, { id: 5, code: "de" }, { id: 6, code: "it" }, { id: 7, code: "at" }, { id: 8, code: "tr" }, { id: 9, code: "ru" }, { id: 10, code: "se" } ];
        const loadedAlliances = [ { "id": 1, "name": "BATTAGLIONE WOLF", "logo_path": "images/logos/BATTAGLIONE WOLF.jpg" }, { "id": 2, "name": "BOHEMIANS", "logo_path": "images/logos/BOHEMIANS.jpg" }, { "id": 3, "name": "GLI ONOREVOLI PICCHIATORI", "logo_path": "images/logos/GLI ONOREVOLI PICCHIATORI.jpeg" }, { "id": 4, "name": "GRANDE ALLEANZA SUPREMA", "logo_path": "images/logos/GRANDE ALLEANZA SUPREMA.jpg" }, { "id": 5, "name": "I CADETTI", "logo_path": "images/logos/I CADETTI.jpg" }, { "id": 6, "name": "I PENETRATORI", "logo_path": "images/logos/I PENETRATORI.jpg" }, { "id": 7, "name": "I RIBELLI DELLA MONTAGNA", "logo_path": "images/logos/I RIBELLI DELLA MONTAGNA.jpg" }, { "id": 8, "name": "INTOCCABILI", "logo_path": "images/logos/INTOCCABILI.jpg" }, { "id": 9, "name": "NONA INVCTA", "logo_path": "images/logos/NONA INVCTA.jpg" }, { "id": 10, "name": "ORDINE DEGLI HASHASHIN", "logo_path": "images/logos/ORDINE DEGLI HASHASHIN.jpg" }, { "id": 11, "name": "ORDINE SUPREMO DELLE AQUILE", "logo_path": "images/logos/ORDINE SUPREMO DELLE AQUILE.jpg" }, { "id": 12, "name": "PATTO DEL MARE DEL NORD", "logo_path": "images/logos/PATTO DEL MARE DEL NORD.jpg" }, { "id": 13, "name": "REGGIMENTO ARDITI", "logo_path": "images/logos/REGGIMENTO ARDITI.jpg" }, { "id": 14, "name": "SOUTH WARRIORS", "logo_path": "images/logos/SOUTH WARRIORS.jpg" }, { "id": 15, "name": "SPARTAN SOLDIERS", "logo_path": "images/logos/SPARTAN SOLDIERS.jpg" }, { "id": 16, "name": "SPREGIUDICATI", "logo_path": "images/logos/SPREGIUDICATI.jpg" } ];
        const soundFiles = { click: 'sounds/click.mp3', turn: 'sounds/turn.mp3', heroYes: 'sounds/hero_yes.mp3', heroNo: 'sounds/hero_no.mp3', error: 'sounds/error.mp3', complete: 'sounds/complete.mp3' };

        // --- Funzioni Utilità i18n ---
        function t(key, params = {}) {
            let translation = translations[currentLanguage]?.[key] || translations['en']?.[key] || `[${key}]`;
            for (const param in params) { const regex = new RegExp(`\\{${param}\\}`, 'g'); translation = translation.replace(regex, params[param]); }
            return translation;
        }
        function detectLanguage() {
            const savedLang = localStorage.getItem('preferredLanguage'); if (savedLang && translations[savedLang]) return savedLang;
            const browserLang = navigator.language || navigator.userLanguage; if (browserLang.startsWith('en') && translations['en']) return 'en';
            return 'it';
        }

        // --- Esecuzione Principale allo Startup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DEBUG] DOMContentLoaded - Inizio script.");

            // --- Variabili Elementi DOM ---
            let loginContainer, gameContainer, playerNameInput, roomIdInput, allianceSelect, joinBtn,
                displayRoomId, displayPlayerName, displayPlayerRole, nationsListEl, p1TeamEl, p2TeamEl,
                p1CountEl, p2CountEl, gamePhaseEl, timerEl, player1El, player2El, resetBtn, copyBtn,
                nationsContainer, heroSelectionSection, heroChoiceButtons, heroYesBtn, heroNoBtn,
                heroWaitMessage, summarySection, timerBarContainer, timerBar, downloadPdfBtn,
                thankYouModal, modalCloseBtn, authStatusEl, langItBtn, langEnBtn;

            // --- Funzioni i18n e Setup Iniziale ---
            function updateStaticTexts() { /* ... Definizione come nella versione precedente ... */ }
            function setLanguage(lang) { /* ... Definizione come nella versione precedente ... */ }

            // 1. Rileva lingua
            currentLanguage = detectLanguage();
            console.log(`[DEBUG] Lingua rilevata: ${currentLanguage}`);

            // 2. Ottieni SUBITO gli elementi per la lingua
            langItBtn = document.getElementById('lang-it');
            langEnBtn = document.getElementById('lang-en');
            console.log("[DEBUG] Elemento lang-it:", langItBtn ? "Trovato" : "NON TROVATO!");
            console.log("[DEBUG] Elemento lang-en:", langEnBtn ? "Trovato" : "NON TROVATO!");

            // 3. Imposta la lingua iniziale
            setLanguage(currentLanguage);

            // 4. Ottieni gli ALTRI elementi DOM
            console.log("[DEBUG] Ottenimento altri elementi DOM...");
            // ... (tutti i getElementById come nella versione precedente) ...
            loginContainer = document.getElementById('login-container'); gameContainer = document.getElementById('game-container'); playerNameInput = document.getElementById('player-name'); roomIdInput = document.getElementById('room-id'); allianceSelect = document.getElementById('alliance-select'); joinBtn = document.getElementById('join-btn'); displayRoomId = document.getElementById('display-room-id'); displayPlayerName = document.getElementById('display-player-name'); displayPlayerRole = document.getElementById('display-player-role'); nationsListEl = document.getElementById('nations-list'); p1TeamEl = document.getElementById('p1-team'); p2TeamEl = document.getElementById('p2-team'); p1CountEl = document.getElementById('p1-count'); p2CountEl = document.getElementById('p2-count'); gamePhaseEl = document.getElementById('game-phase'); timerEl = document.getElementById('timer'); player1El = document.getElementById('player1'); player2El = document.getElementById('player2'); resetBtn = document.getElementById('reset-btn'); copyBtn = document.getElementById('copy-btn'); nationsContainer = document.getElementById('nations-container'); heroSelectionSection = document.getElementById('hero-selection-section'); heroChoiceButtons = document.getElementById('hero-choice-buttons'); heroYesBtn = document.getElementById('hero-yes-btn'); heroNoBtn = document.getElementById('hero-no-btn'); heroWaitMessage = document.getElementById('hero-wait-message'); summarySection = document.getElementById('summary-section'); timerBarContainer = document.getElementById('timer-bar-container'); timerBar = document.getElementById('timer-bar'); downloadPdfBtn = document.getElementById('download-pdf-btn'); thankYouModal = document.getElementById('thank-you-modal'); modalCloseBtn = document.getElementById('modal-close-btn'); authStatusEl = document.getElementById('auth-status');
            console.log("[DEBUG] Ottenimento elementi DOM completato.");

            // 5. Applica nuovamente traduzioni statiche
            updateStaticTexts();

            // --- Funzioni Utilità Gioco ---
            function getNationData(nationId) { /* ... Definizione come nella versione precedente ... */ }
            function initializeAudio() { /* ... Definizione come nella versione precedente ... */ }
            function unlockAudioContext() { /* ... Definizione come nella versione precedente ... */ }
            function playSound(soundName) { /* ... Definizione come nella versione precedente ... */ }
            function getAllianceById(id) { /* ... Definizione come nella versione precedente ... */ }
            function generateRoomId() { /* ... Definizione come nella versione precedente ... */ }

            // --- Funzioni Logica Principale ---
            function handleJoinClick() { /* ... Definizione come nella versione precedente ... */ }
            function joinRoom(selectedAllianceId) { /* ... Definizione come nella versione precedente ... */ }
            function resetLoginUI() { /* ... Definizione come nella versione precedente ... */ }
            function initializeGameView() { /* ... Definizione come nella versione precedente ... */ }
            function initializeGame(selectedAllianceId) { /* ... Definizione come nella versione precedente ... */ }
            function listenToRoomChanges() { /* ... Definizione come nella versione precedente ... */ }
            function startDraft() { /* ... Definizione come nella versione precedente ... */ }
            function updateUI() { /* ... Definizione come nella versione precedente ... */ }
            function startTimer() { /* ... Definizione come nella versione precedente ... */ }
            function skipTurn() { /* ... Definizione come nella versione precedente ... */ }
            function selectNationWithAnimation(cardElement, nationData) { /* ... Definizione come nella versione precedente ... */ }
            function selectNation(nationData) { /* ... Definizione come nella versione precedente ... */ }
            function handleHeroChoice(choice) { /* ... Definizione come nella versione precedente ... */ }
            function generateAndDownloadPDF() { /* ... Definizione come nella versione precedente ... */ }
            function getHeroStatusText(choice) { /* ... Definizione come nella versione precedente ... */ }
            function populateSummary() { /* ... Definizione come nella versione precedente ... */ }
            function renderTeams() { /* ... Definizione come nella versione precedente ... */ }
            function renderNations() { /* ... Definizione come nella versione precedente ... */ }
            function updateGamePhaseDisplay() { /* ... Definizione come nella versione precedente ... */ }
            function handleGameEndCleanup() { /* ... Definizione come nella versione precedente ... */ }
            function handleCopyClick() { /* ... Definizione come nella versione precedente ... */ }
            function handleResetClick() { /* ... Definizione come nella versione precedente ... */ }
            function handleModalClose() { /* ... Definizione come nella versione precedente ... */ }
            function handleModalOverlayClick(event) { /* ... Definizione come nella versione precedente ... */ }
            function handleDownloadPdfClick() { /* ... Definizione come nella versione precedente ... */ }

             // --- Setup Applicazione (viene chiamata dopo autenticazione Firebase) ---
             function setupApplication() { /* ... Definizione come nella versione precedente ... */ }

            // 6. Inizializza Firebase (chiama setupApplication nel .then())
            console.log("[DEBUG] Inizio inizializzazione Firebase...");
             try {
                 if (typeof firebase === 'undefined') throw new Error("Firebase SDK non caricato.");
                 if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); console.log("[DEBUG] Firebase App Inizializzata."); }
                 else { firebase.app(); console.log("[DEBUG] Firebase App già inizializzata."); }
                 database = firebase.database(); auth = firebase.auth();
                 console.log("[DEBUG] Avvio autenticazione anonima...");
                 if (authStatusEl) authStatusEl.textContent = t('authStatusAuthenticating');

                 auth.signInAnonymously()
                   .then(() => {
                     const user = auth.currentUser; console.log("[DEBUG] Auth anonima RIUSCITA. UID:", user ? user.uid : 'N/D');
                     isAuthComplete = true; if (authStatusEl) { authStatusEl.textContent = t('authStatusReady'); authStatusEl.style.color = "darkgreen"; }
                     setupApplication(); // CHIAMATA A SETUP DOPO AUTH
                   })
                   .catch((error) => {
                       console.error("!!! ERRORE CRITICO Auth Anonima:", error);
                       isAuthComplete = false;
                       if (authStatusEl) { authStatusEl.textContent = t('authStatusError', { error: error.message }); authStatusEl.style.color = "red"; }
                       alert(t('alertErrorAuthGeneric', { code: error.code }));
                       if (joinBtn) joinBtn.disabled = true;
                   });

                 const connectedRef = database.ref(".info/connected");
                 connectedRef.on("value", (snap) => { /* ... log connessione ... */ });

             } catch (e) {
                 console.error("ERRORE CRITICO Init Firebase:", e);
                 isAuthComplete = false;
                 alert(t('alertErrorFirebaseInit', { message: e.message }));
                 if (authStatusEl) { authStatusEl.textContent = "Errore Init Critico!"; authStatusEl.style.color = "red"; }
                  if (joinBtn) joinBtn.disabled = true;
             }

        }); // Fine DOMContentLoaded


        // --- RIPETIZIONE FUNZIONI CHIAVE per assicurare che siano definite nello scope globale ---
        // (Queste sono definite *fuori* dal DOMContentLoaded ma dopo le variabili globali)

        // Oggetto traduzioni già definito sopra...
        // Array e costanti già definiti sopra...

        // --- FUNZIONI i18n (ri-definite per scope globale se necessario, ma dovrebbero bastare quelle interne) ---
        function t(key, params = {}) {
            let translation = translations[currentLanguage]?.[key] || translations['en']?.[key] || `[${key}]`;
            for (const param in params) { const regex = new RegExp(`\\{${param}\\}`, 'g'); translation = translation.replace(regex, params[param]); }
            return translation;
        }
        function detectLanguage() {
            const savedLang = localStorage.getItem('preferredLanguage'); if (savedLang && translations[savedLang]) return savedLang;
            const browserLang = navigator.language || navigator.userLanguage; if (browserLang.startsWith('en') && translations['en']) return 'en';
            return 'it';
        }
        // NOTA: Le funzioni come setLanguage, updateStaticTexts, etc., sono definite *dentro* DOMContentLoaded
        // e fanno riferimento alle variabili degli elementi DOM definite lì. Questo è corretto.
        // Non è necessario ridefinirle qui fuori.

    </script>

</body>
</html>
